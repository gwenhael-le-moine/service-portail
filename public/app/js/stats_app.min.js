var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,d){a!=Array.prototype&&a!=Object.prototype&&(a[c]=d.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var a=0;return function(c){return $jscomp.SYMBOL_PREFIX+(c||"")+a++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var c=0;return $jscomp.iteratorPrototype(function(){return c<a.length?{done:!1,value:a[c++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.iteratorFromArray=function(a,c){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var d=0,e={next:function(){if(d<a.length){var f=d++;return{value:c(f,a[f]),done:!1}}e.next=function(){return{done:!0,value:void 0}};return e.next()}};e[Symbol.iterator]=function(){return e};return e};
$jscomp.polyfill=function(a,c,d,e){if(c){d=$jscomp.global;a=a.split(".");for(e=0;e<a.length-1;e++){var f=a[e];f in d||(d[f]={});d=d[f]}a=a[a.length-1];e=d[a];c=c(e);c!=e&&null!=c&&$jscomp.defineProperty(d,a,{configurable:!0,writable:!0,value:c})}};$jscomp.polyfill("Array.prototype.values",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a,d){return d})}},"es8","es3");
$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
angular.module("statsApp",["ui.bootstrap","nvd3","angularMoment","chieffancypants.loadingBar"]).run(["amMoment",function(a){a.changeLocale("fr")}]).config(["$httpProvider",function(a){a.defaults.withCredentials=!0}]).component("stats",{controller:["$http","$locale","$q","moment","URL_ENT",function(a,c,d,e,f){var b=this;b.allowed=!1;b.decr_period=function(){b.debut.subtract(1,b.period_types.selected+"s");b.retrieve_data()};b.incr_period=function(){b.debut.add(1,b.period_types.selected+"s");b.retrieve_data()};
b.reset_period=function(){b.debut=e().startOf(b.period_types.selected);b.retrieve_data()};b.types_labels={global:"Statistiques globales",structure_id:"\u00c9tablissements",application_id:"Tuiles",profil_id:"Profils utilisateurs",user_id:"Utilisateurs",week_day:"Jour de la semaine"};b.period_types={list:[{label:"jour",value:"day"},{label:"semaine",value:"week"},{label:"mois",value:"month"}],selected:"week"};b.multibarchart_options={chart:{type:"multiBarChart",height:256,width:1050,margin:{left:50,
top:20,bottom:100,right:20},showControls:!1,showValues:!0,showLegend:!0,stacked:!1,duration:500,labelThreshold:.01,labelSunbeamLayout:!0,rotateLabels:-25,reduceXTicks:!1}};b.multibarhorizontalchart_options=angular.copy(b.multibarchart_options);b.multibarhorizontalchart_options.chart.type="multiBarHorizontalChart";b.multibarhorizontalchart_options.chart.height=512;b.multibarhorizontalchart_options.chart.margin={left:250,top:20,bottom:20,right:50};b.chart_options=function(a,c){switch(a){case "structure_id":case "profil_id":return b.multibarhorizontalchart_options.chart.height=
24*c.length*c[0].values.length+40,b.multibarhorizontalchart_options.chart.margin.left=8*_.chain(c[0].values).pluck("x").map(function(b){return b.length}).max().value(),b.multibarhorizontalchart_options;default:return b.multibarchart_options}};b.labels={};b.labels.week_day=angular.copy(c.DATETIME_FORMATS.DAY);b.labels.week_day.push(b.labels.week_day.shift());b.retrieve_data=function(){b.fin=b.debut.clone().endOf(b.period_types.selected);a.get(f+"/api/logs",{params:{"timestamp\x3e":b.debut.clone().toDate(),
"timestamp\x3c":b.fin.clone().toDate(),"structure_id[]":_.chain(b.labels.structure_id).keys().reject(function(b){return _(["0699990Z","069BACAS","069DANEZ"]).contains(b)}).value()}}).then(function(a){var c=["structure_id","application_id","profil_id","week_day"],d=function(a,c){return[{key:a,values:_.chain(c).keys().map(function(g){return{key:a,value:g,x:b.labels[a][g],y:c[g]}}).sortBy(function(b){switch(a){case "structure_id":case "profil_id":return-1*b.y;case "week_day":return!0;default:return b.x}}).value()}]},
e=function(b,a){return _.chain(a).map(function(a){return[a,d(a,_(b).countBy(a))]}).object().value()};b.logs=a.data;b.filters={};b.stats={};b.stats.global=e(b.logs,c);c.forEach(function(a){"week_day"!==a&&(b.stats[a]=_.chain(b.stats.global[a][0].values).pluck("value").map(function(d){return[d,e(_(b.logs).select(function(b){return b[a]===d}),_(c).difference([a]))]}).object().value())});b.stats.global.structure_id.push({key:"utilisateurs uniques",values:_.chain(b.logs).groupBy(function(a){return a.structure_id}).map(function(a,
c){return{key:"utilisateurs uniques",x:b.labels.structure_id[c],y:_.chain(a).pluck("user_id").uniq().value().length}}).value()});b.stats.global.structure_id.push({key:"apps",values:_.chain(b.logs).groupBy(function(a){return a.structure_id}).map(function(a,c){return{key:"apps",x:b.labels.structure_id[c],y:_.chain(a).pluck("application_id").uniq().value().length}}).value()});b.stats.global.profil_id.push({key:"utilisateurs uniques",values:_.chain(b.logs).groupBy(function(a){return a.profil_id}).map(function(a,
c){return{key:"utilisateurs uniques",x:b.labels.profil_id[c],y:_.chain(a).pluck("user_id").uniq().value().length}}).value()});_(b.stats.structure_id).each(function(a,c){a.profil_id.push({key:"utilisateurs uniques",values:_.chain(b.logs).where({structure_id:c}).groupBy(function(a){return a.profil_id}).map(function(a,c){return{key:"utilisateurs uniques",x:b.labels.profil_id[c],y:_.chain(a).pluck("user_id").uniq().value().length}}).value()})})})};a.get(f+"/api/users/current").then(function(c){b.allowed=
0<_.chain(c.data.profiles).pluck("type").intersection(["DIR","ADM"]).value().length;b.allowed&&(c=[a.get(f+"/api/profiles_types").then(function(a){b.labels.profil_id=_.chain(a.data).map(function(a){return[a.id,a.name]}).object().value()}),a.get(f+"/api/applications").then(function(a){b.labels.application_id=_.chain(a.data).map(function(a){return[a.id,a.name]}).object().value()}),a.get(f+"/api/structures_types").then(function(a){b.structures_types=a.data}),a.get(f+"/api/structures",{params:{expand:!1}}).then(function(a){console.log(a.data);
b.labels.structure_id=_.chain(a.data).map(function(a){return[a.id,a.name+" ("+a.id+")"]}).object().value()})],d.all(c).then(function(a){b.reset_period()}))})}],template:'\n  \x3cdiv ng:if\x3d"$ctrl.allowed"\x3e\n    \x3ch2\x3e\n      \x3cselect ng:options\x3d"period_type.value as period_type.label for period_type in $ctrl.period_types.list"\n              ng:model\x3d"$ctrl.period_types.selected"\n              ng:change\x3d"$ctrl.reset_period()"\x3e\x3c/select\x3e\n      \x3cbutton class\x3d"btn btn-lg" ng:click\x3d"$ctrl.reset_period()"\x3e \u2715 \x3c/button\x3e\n      \x3cbutton class\x3d"btn btn-lg" ng:click\x3d"$ctrl.decr_period()"\x3e \x3c \x3c/button\x3e\n                                                                   \x3cbutton class\x3d"btn btn-lg" ng:click\x3d"$ctrl.incr_period()"\x3e \x3e \x3c/button\x3e\n      {{ $ctrl.debut | amDateFormat:\'dddd Do MMMM YYYY\' }} - {{ $ctrl.fin | amDateFormat:\'dddd Do MMMM YYYY\' }}\n    \x3c/h2\x3e\n\n    \x3cdiv class\x3d"col-md-12"\n         ng:repeat\x3d"(type, values) in $ctrl.stats"\x3e\n      \x3cdiv class\x3d"panel panel-default"\n           ng:if\x3d"type \x3d\x3d\x3d \'global\'"\x3e\n        \x3cdiv class\x3d"panel-heading"\x3e{{$ctrl.types_labels[type]}}\x3c/div\x3e\n        \x3cdiv class\x3d"panel-body"\x3e\n          \x3cuib-tabset\x3e\n            \x3cuib-tab index\x3d"$index + 1"\n                     ng:repeat\x3d"(key, stat) in values"\n                     heading\x3d"{{stat[0].values.length}} {{$ctrl.types_labels[key]}}"\x3e\n              \x3cnvd3 data\x3d"stat"\n                    options\x3d"$ctrl.chart_options( key, stat )"\x3e\n              \x3c/nvd3\x3e\n            \x3c/uib-tab\x3e\n          \x3c/uib-tabset\x3e\n        \x3c/div\x3e\n      \x3c/div\x3e\n\n      \x3cdiv class\x3d"panel panel-default"\n           ng:if\x3d"type !\x3d\x3d \'global\'"\x3e\n        \x3cdiv class\x3d"panel-heading"\x3eStatistiques par {{$ctrl.types_labels[type]}}\x3c/div\x3e\n        \x3cdiv class\x3d"panel-body"\x3e\n          \x3cuib-tabset\x3e\n            \x3cuib-tab index\x3d"$index + 1"\n                     ng:repeat\x3d"(key, value) in values"\n                     heading\x3d"{{value[0].values.length}} {{$ctrl.labels[type][key]}}"\x3e\n              \x3cuib-tabset\x3e\n                \x3cuib-tab index\x3d"$index + 1"\n                         ng:repeat\x3d"(subkey, stat) in value"\n                         heading\x3d"{{stat[0].values.length}} {{$ctrl.types_labels[subkey]}}"\x3e\n                  \x3cnvd3 data\x3d"stat"\n                        options\x3d"$ctrl.chart_options( subkey, stat )"\x3e\n                  \x3c/nvd3\x3e\n                \x3c/uib-tab\x3e\n              \x3c/uib-tabset\x3e\n            \x3c/uib-tab\x3e\n          \x3c/uib-tabset\x3e\n        \x3c/div\x3e\n      \x3c/div\x3e\n    \x3c/div\x3e\n  \x3c/div\x3e\n'});
