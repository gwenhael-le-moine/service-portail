var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,c,g){b!=Array.prototype&&b!=Object.prototype&&(b[c]=g.value)};$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var b=0;return function(c){return $jscomp.SYMBOL_PREFIX+(c||"")+b++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var b=$jscomp.global.Symbol.iterator;b||(b=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[b]&&$jscomp.defineProperty(Array.prototype,b,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(b){var c=0;return $jscomp.iteratorPrototype(function(){return c<b.length?{done:!1,value:b[c++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(b){$jscomp.initSymbolIterator();b={next:b};b[$jscomp.global.Symbol.iterator]=function(){return this};return b};$jscomp.iteratorFromArray=function(b,c){$jscomp.initSymbolIterator();b instanceof String&&(b+="");var g=0,f={next:function(){if(g<b.length){var h=g++;return{value:c(h,b[h]),done:!1}}f.next=function(){return{done:!0,value:void 0}};return f.next()}};f[Symbol.iterator]=function(){return f};return f};
$jscomp.polyfill=function(b,c,g,f){if(c){g=$jscomp.global;b=b.split(".");for(f=0;f<b.length-1;f++){var h=b[f];h in g||(g[h]={});g=g[h]}b=b[b.length-1];f=g[b];c=c(f);c!=f&&null!=c&&$jscomp.defineProperty(g,b,{configurable:!0,writable:!0,value:c})}};$jscomp.polyfill("Array.prototype.values",function(b){return b?b:function(){return $jscomp.iteratorFromArray(this,function(b,g){return g})}},"es8","es3");
$jscomp.polyfill("Array.prototype.keys",function(b){return b?b:function(){return $jscomp.iteratorFromArray(this,function(b){return b})}},"es6","es3");
angular.module("statsApp",["ui.bootstrap","nvd3","angularMoment"]).run(["amMoment",function(b){b.changeLocale("fr")}]).config(["$httpProvider",function(b){b.defaults.withCredentials=!0}]).component("loaderSpinner",{template:"\n\x3cstyle\x3e\n  .loader,\n  .loader:before,\n  .loader:after {\n  border-radius: 50%;\n  }\n  .loader {\n  color: #1aaacc;\n  font-size: 11px;\n  text-indent: -99999em;\n  margin: 55px auto;\n  position: relative;\n  width: 10em;\n  height: 10em;\n  box-shadow: inset 0 0 0 1em;\n  -webkit-transform: translateZ(0);\n  -ms-transform: translateZ(0);\n  transform: translateZ(0);\n  }\n  .loader:before,\n  .loader:after {\n  position: absolute;\n  content: '';\n  }\n  .loader:before {\n  width: 5.2em;\n  height: 10.2em;\n  background: #ffffff;\n  border-radius: 10.2em 0 0 10.2em;\n  top: -0.1em;\n  left: -0.1em;\n  -webkit-transform-origin: 5.2em 5.1em;\n  transform-origin: 5.2em 5.1em;\n  -webkit-animation: load2 2s infinite ease 1.5s;\n  animation: load2 2s infinite ease 1.5s;\n  }\n  .loader:after {\n  width: 5.2em;\n  height: 10.2em;\n  background: #ffffff;\n  border-radius: 0 10.2em 10.2em 0;\n  top: -0.1em;\n  left: 5.1em;\n  -webkit-transform-origin: 0px 5.1em;\n  transform-origin: 0px 5.1em;\n  -webkit-animation: load2 2s infinite ease;\n  animation: load2 2s infinite ease;\n  }\n  @-webkit-keyframes load2 {\n  0% {\n  -webkit-transform: rotate(0deg);\n  transform: rotate(0deg);\n  }\n  100% {\n  -webkit-transform: rotate(360deg);\n  transform: rotate(360deg);\n  }\n  }\n  @keyframes load2 {\n  0% {\n  -webkit-transform: rotate(0deg);\n  transform: rotate(0deg);\n  }\n  100% {\n  -webkit-transform: rotate(360deg);\n  transform: rotate(360deg);\n  }\n  }\n\x3c/style\x3e\n\x3cdiv class\x3d\"loader\"\x3eLoading...\x3c/div\x3e\n"}).component("stats",{controller:["$http",
"$locale","$q","moment","URL_ENT",function(b,c,g,f,h){var a=this;a.allowed=!1;a.loading=!1;a.period={decr:function(){a.debut.subtract(1,a.period_types.selected+"s");a.fin=a.debut.clone().endOf(a.period_types.selected)},incr:function(){a.debut.add(1,a.period_types.selected+"s");a.fin=a.debut.clone().endOf(a.period_types.selected)},reset:function(){a.debut=f().startOf(a.period_types.selected);a.fin=a.debut.clone().endOf(a.period_types.selected)}};a.types_labels={structure_id:"\u00c9tablissements",application_id:"Tuiles",
profil_id:"Profils",user_id:"Utilisateurs",weekday:"Jours",hour:"Heures",url:"URLs"};a.period_types={list:[{label:"journ\u00e9e",value:"day"},{label:"semaine",value:"week"},{label:"mois",value:"month"},{label:"ann\u00e9e",value:"year"}],selected:"week"};["cities","structures_types","profiles_types","structures","applications"].forEach(function(b){a[b]={list:[],selected:[]}});a.multibarchart_options={chart:{type:"multiBarChart",x:function(a){return a.x},y:function(a){return a.y},valueFormat:function(a){return a},
height:256,width:1050,margin:{left:50,top:20,bottom:100,right:20},showControls:!1,showValues:!0,showLegend:!0,stacked:!1,duration:500,labelThreshold:.01,labelSunbeamLayout:!0,rotateLabels:-25,reduceXTicks:!1,yAxis:{tickFormat:function(a){return d3.format(",.0f")(a)}},xAxis:{}}};a.multibarhorizontalchart_options=angular.copy(a.multibarchart_options);a.multibarhorizontalchart_options.chart.type="multiBarHorizontalChart";a.multibarhorizontalchart_options.chart.height=512;a.multibarhorizontalchart_options.chart.margin=
{left:250,top:20,bottom:20,right:50};a.chart_options=function(b,d){switch(b){case "structure_id":case "profil_id":return b=8*_.chain(d[0].values).pluck("x").map(function(a){return a.length}).max().value(),a.multibarhorizontalchart_options.chart.height=24*d.length*d[0].values.length+40,a.multibarhorizontalchart_options.chart.margin.left=250<b?250:b,a.multibarhorizontalchart_options.chart.xAxis.orient="left",a.multibarhorizontalchart_options.chart.showXAxis=!0,a.multibarhorizontalchart_options;case "url":return a.multibarhorizontalchart_options.chart.height=
24*d.length*d[0].values.length+40,a.multibarhorizontalchart_options.chart.xAxis.orient="right",a.multibarhorizontalchart_options.chart.margin.left=10,a.multibarhorizontalchart_options;default:return a.multibarchart_options}};a.labels={weekday:_.memoize(function(a){var b=angular.copy(c.DATETIME_FORMATS.DAY);b.push(b.shift());return a+" "+b[a]}),hour:function(a){10>a&&(a="0"+a);return a+":00 - "+a+":59"},url:angular.identity};a.process_data=function(b){a.logs=_(b).map(function(a){a.timestamp=f(a.timestamp);
a.weekday=a.timestamp.day();a.hour=a.timestamp.hour();return a});a.logs_SSO=_(a.logs).where({application_id:"SSO"});var d=f().subtract(4,"hours");a.totals={clicks:a.logs.length,users:_.chain(a.logs).countBy(function(a){return a.user_id}).size().value(),connections:a.logs_SSO.length,active_connections:_(a.logs_SSO).select(function(a){return a.timestamp.isAfter(d)}).length};a.logs=_(a.logs).reject(function(a){return"SSO"==a.application_id});a.log_structures=_.chain(a.logs).pluck("structure_id").uniq().map(function(b){return _(a.structures).findWhere({id:b})}).value();
a.log_applications=_.chain(a.logs).pluck("application_id").uniq().map(function(b){return _(a.applications).findWhere({id:b})}).value();a.log_profiles_types=_.chain(a.logs).pluck("profil_id").uniq().map(function(b){return _(a.profiles_types).findWhere({id:b})}).value();a.stats=_.chain("structure_id application_id profil_id weekday hour url".split(" ")).map(function(b){var e=_.chain(a.logs).select(function(a){return"url"!=b||null!=a[b].match(/^http.*/)}).countBy(b).value();return[b,[{key:"clicks",values:_.chain(e).keys().map(function(d){return{key:b,
value:d,x:a.labels[b](d),y:e[d]}}).sortBy(function(a){switch(b){case "structure_id":case "profil_id":case "url":return-1*a.y;default:return a.x}}).value()}]]}).object().value();var e=function(b,e,d){return _.chain(b).groupBy(function(a){return a[d]}).map(function(b,c){return{x:a.labels[d](c),y:_.chain(b).pluck(e).uniq().value().length}}).value()};["structure_id","application_id","profil_id","weekday","hour"].forEach(function(b){a.stats[b].push({key:"utilisateurs uniques",values:e(a.logs,"user_id",
b)})});["structure_id","profil_id"].forEach(function(b){var d=e(a.logs,"user_id",b),c=e(a.logs,"id",b);a.stats[b].push({key:"nombre de clicks moyens par utilisateur unique",values:_(c).map(function(a){a.y/=_(d).findWhere({x:a.x}).y;return a})})});a.stats.structure_id.push({key:"apps",values:e(a.logs,"application_id","structure_id")})};a.filter_data=function(b){return _(b).select(function(b){return(0==a.structures_types.selected.length||_.chain(a.structures.list).select(function(b){return _.chain(a.structures_types.selected).pluck("id").contains(b.type).value()}).pluck("id").contains(b.structure_id).value())&&
(0==a.cities.selected.length||_.chain(a.structures.list).select(function(b){return _.chain(a.cities.selected).pluck("zip_code").contains(b.zip_code).value()}).pluck("id").contains(b.structure_id).value())&&(0==a.applications.selected.length||_.chain(a.applications.selected).pluck("id").contains(b.application_id).value())&&(0==a.structures.selected.length||_.chain(a.structures.selected).pluck("id").contains(b.structure_id).value())&&(0==a.profiles_types.selected.length||_.chain(a.profiles_types.selected).pluck("id").contains(b.profil_id).value())})};
a.retrieve_data=function(){a.loading=!0;a.raw_logs=[];b.get(h+"/api/logs",{params:{"timestamp\x3e":a.debut.clone().toDate(),"timestamp\x3c":a.fin.clone().toDate()}}).then(function(c){a.raw_logs=c.data;0<a.raw_logs.length?b.get(h+"/api/structures",{params:{expand:!1,"id[]":_.chain(a.raw_logs).pluck("structure_id").uniq().value()}}).then(function(b){a.structures.list=b.data;a.labels.structure_id=function(b){var e="",d=_(a.structures.list).findWhere({id:b});void 0!=d&&(e=d.name);return e+" ("+b+")"};
a.cities.list=_.chain(a.structures.list).map(function(a){return{zip_code:a.zip_code,city:a.city}}).uniq(function(a){return a.zip_code}).reject(function(a){return null==a.zip_code||""==a.zip_code}).value()}).then(function(){a.process_data(a.filter_data(a.raw_logs));a.loading=!1}):a.loading=!1})};a.download_json=function(a,b){var e=document.createElement("a");e.href="data:application/json;charset\x3dutf-8,"+JSON.stringify(a);e.setAttribute("download",b+".json");document.body.appendChild(e);e.click();
document.body.removeChild(e)};b.get(h+"/api/users/current").then(function(c){a.allowed=0<_.chain(c.data.profiles).pluck("type").intersection(["DIR","ADM"]).value().length;a.allowed&&(c=[b.get(h+"/api/profiles_types").then(function(b){a.profiles_types.list=b.data;a.labels.profil_id=_.memoize(function(b){var c=b;b=_(a.profiles_types.list).findWhere({id:b});void 0!=b&&(c=b.name);return c})}),b.get(h+"/api/applications").then(function(b){a.applications.list=b.data;a.labels.application_id=_.memoize(function(b){var c=
b;b=_(a.applications.list).findWhere({id:b});void 0!=b&&(c=b.name);return c})}),b.get(h+"/api/structures_types").then(function(b){a.structures_types.list=b.data})],g.all(c).then(function(b){a.period.reset()}))})}],template:'\n    \x3cdiv class\x3d"container" ng:if\x3d"$ctrl.allowed"\x3e\n      \x3cdiv class\x3d"col-md-12" style\x3d"text-align: center;"\x3e\n        \x3cdiv class\x3d"controls pull-right"\x3e\n          \x3cselect ng:options\x3d"period_type.value as period_type.label for period_type in $ctrl.period_types.list"\n                  ng:model\x3d"$ctrl.period_types.selected"\n                  ng:change\x3d"$ctrl.period.reset()"\x3e\x3c/select\x3e\n          \x3cbutton class\x3d"btn btn-warning" ng:click\x3d"$ctrl.period.reset()"\x3e \u2715 \x3c/button\x3e\n          \x3cbutton class\x3d"btn btn-primary" ng:click\x3d"$ctrl.period.decr()"\x3e \u25c0 \x3c/button\x3e\n          \x3cbutton class\x3d"btn btn-primary" ng:click\x3d"$ctrl.period.incr()"\x3e \u25b6 \x3c/button\x3e\n          \x3cbutton class\x3d"btn btn-success" ng:click\x3d"$ctrl.retrieve_data()"\x3e Valider \x3c/button\x3e\n        \x3c/div\x3e\n        \x3ch2\x3e\n          {{ $ctrl.debut | amDateFormat:\'Do MMMM YYYY\' }} - {{ $ctrl.fin | amDateFormat:\'Do MMMM YYYY\' }}\n        \x3c/h2\x3e\n      \x3c/div\x3e\n      \x3ch1 style\x3d"text-align: center;" ng:if\x3d"$ctrl.raw_logs.length \x3d\x3d 0 \x26\x26 !$ctrl.loading"\x3e\n        \x3cspan class\x3d"label label-primary"\x3eAucune donn\u00e9e disponible pour la p\u00e9riode donn\u00e9e.\x3c/span\x3e\n      \x3c/h1\x3e\n      \x3ch1 style\x3d"text-align: center;" ng:if\x3d"$ctrl.raw_logs.length \x3d\x3d 0 \x26\x26 $ctrl.loading"\x3e\n        \x3cspan class\x3d"label label-warning"\x3eChargement et traitement des donn\u00e9es en cours...\x3c/span\x3e\n        \x3cloader-spinner\x3e\x3c/loader-spinner\x3e\n      \x3c/h1\x3e\n      \x3cdiv ng:if\x3d"$ctrl.raw_logs.length \x3e 0 \x26\x26 !$ctrl.loading"\x3e\n        \x3cdiv class\x3d"col-md-12"\x3e\n\n          \x3cdiv class\x3d"col-md-3"\x3e\n            \x3cdiv class\x3d"panel panel-default"\x3e\n              \x3cdiv class\x3d"panel-heading"\x3e\n                Communes \x3cbutton class\x3d"btn btn-xs btn-warning pull-right" ng:click\x3d"$ctrl.cities.selected \x3d []; $ctrl.process_data($ctrl.filter_data($ctrl.raw_logs));"\x3e \u2715 \x3c/button\x3e\n              \x3c/div\x3e\n              \x3cdiv class\x3d"panel-body" style\x3d"padding: 0;"\x3e\n                \x3cselect multiple style\x3d"width: 100%;"\n                        ng:options\x3d"city as city.zip_code + \' : \' + city.city for city in $ctrl.cities.list | orderBy:\'zip_code\'"\n                        ng:model\x3d"$ctrl.cities.selected"\n                        ng:change\x3d"$ctrl.process_data($ctrl.filter_data($ctrl.raw_logs));"\x3e\x3c/select\x3e\n              \x3c/div\x3e\n            \x3c/div\x3e\n          \x3c/div\x3e\n\n          \x3cdiv class\x3d"col-md-3"\x3e\n            \x3cdiv class\x3d"panel panel-default"\x3e\n              \x3cdiv class\x3d"panel-heading"\x3e\n                \u00c9tablissements \x3cbutton class\x3d"btn btn-xs btn-warning pull-right" ng:click\x3d"$ctrl.structures.selected \x3d []; $ctrl.process_data($ctrl.filter_data($ctrl.raw_logs));"\x3e \u2715 \x3c/button\x3e\n              \x3c/div\x3e\n              \x3cdiv class\x3d"panel-body" style\x3d"padding: 0;"\x3e\n                \x3cselect multiple style\x3d"width: 100%;"\n                        ng:options\x3d"structure as structure.name for structure in $ctrl.structures.list | orderBy:\'name\'"\n                        ng:model\x3d"$ctrl.structures.selected"\n                        ng:change\x3d"$ctrl.process_data($ctrl.filter_data($ctrl.raw_logs));"\x3e\x3c/select\x3e\n              \x3c/div\x3e\n            \x3c/div\x3e\n          \x3c/div\x3e\n\n          \x3cdiv class\x3d"col-md-2"\x3e\n            \x3cdiv class\x3d"panel panel-default"\x3e\n              \x3cdiv class\x3d"panel-heading"\x3e\n                Structures \x3cbutton class\x3d"btn btn-xs btn-warning pull-right" ng:click\x3d"$ctrl.structures_types.selected \x3d []; $ctrl.process_data($ctrl.filter_data($ctrl.raw_logs));"\x3e \u2715 \x3c/button\x3e\n              \x3c/div\x3e\n              \x3cdiv class\x3d"panel-body" style\x3d"padding: 0;"\x3e\n                \x3cselect multiple style\x3d"width: 100%;"\n                        ng:options\x3d"st as \'\' + st.name for st in $ctrl.structures_types.list | orderBy:\'name\'"\n                        ng:model\x3d"$ctrl.structures_types.selected"\n                        ng:change\x3d"$ctrl.process_data($ctrl.filter_data($ctrl.raw_logs));"\x3e\x3c/select\x3e\n              \x3c/div\x3e\n            \x3c/div\x3e\n          \x3c/div\x3e\n\n          \x3cdiv class\x3d"col-md-2"\x3e\n            \x3cdiv class\x3d"panel panel-default"\x3e\n              \x3cdiv class\x3d"panel-heading"\x3e\n                Profils \x3cbutton class\x3d"btn btn-xs btn-warning pull-right" ng:click\x3d"$ctrl.profiles_types.selected \x3d []; $ctrl.process_data($ctrl.filter_data($ctrl.raw_logs));"\x3e \u2715 \x3c/button\x3e\n              \x3c/div\x3e\n              \x3cdiv class\x3d"panel-body" style\x3d"padding: 0;"\x3e\n                \x3cselect multiple style\x3d"width: 100%;"\n                        ng:options\x3d"pt as pt.name for pt in $ctrl.profiles_types.list | orderBy:\'name\'"\n                        ng:model\x3d"$ctrl.profiles_types.selected"\n                        ng:change\x3d"$ctrl.process_data($ctrl.filter_data($ctrl.raw_logs));"\x3e\x3c/select\x3e\n              \x3c/div\x3e\n            \x3c/div\x3e\n          \x3c/div\x3e\n\n          \x3cdiv class\x3d"col-md-2"\x3e\n            \x3cdiv class\x3d"panel panel-default"\x3e\n              \x3cdiv class\x3d"panel-heading"\x3e\n                Tuiles \x3cbutton class\x3d"btn btn-xs btn-warning pull-right" ng:click\x3d"$ctrl.applications.selected \x3d []; $ctrl.process_data($ctrl.filter_data($ctrl.raw_logs));"\x3e \u2715 \x3c/button\x3e\n              \x3c/div\x3e\n              \x3cdiv class\x3d"panel-body" style\x3d"padding: 0;"\x3e\n                \x3cselect multiple style\x3d"width: 100%;"\n                        ng:options\x3d"app as app.name for app in $ctrl.applications.list | orderBy:\'name\'"\n                        ng:model\x3d"$ctrl.applications.selected"\n                        ng:change\x3d"$ctrl.process_data($ctrl.filter_data($ctrl.raw_logs));"\x3e\x3c/select\x3e\n              \x3c/div\x3e\n            \x3c/div\x3e\n          \x3c/div\x3e\n\n        \x3c/div\x3e\n\n        \x3cdiv class\x3d"col-md-12"\x3e\n          \x3cem class\x3d"col-md-3 label label-default"\x3e{{$ctrl.totals.clicks}} clicks\x3c/em\x3e\n          \x3cem class\x3d"col-md-3 label label-primary"\x3e{{$ctrl.totals.users}} utilisateurs uniques\x3c/em\x3e\n          \x3cem class\x3d"col-md-3 label label-success"\x3e{{$ctrl.totals.connections}} connexions\x3c/em\x3e\n          \x3cem class\x3d"col-md-3 label label-info"\x3e{{$ctrl.totals.active_connections}} connexions actives\x3c/em\x3e\n        \x3c/div\x3e\n\n        \x3cuib-tabset\x3e\n          \x3cuib-tab index\x3d"$index + 1"\n                   ng:repeat\x3d"(key, stat) in $ctrl.stats"\x3e\n            \x3cuib-tab-heading\x3e\n              \x3cem class\x3d"badge"\x3e{{stat[0].values.length}}\x3c/em\x3e {{$ctrl.types_labels[key]}} \x3cbutton class\x3d"btn btn-xs btn-primary" ng:click\x3d"$ctrl.download_json(stat, key)"\x3e\x3cspan class\x3d"glyphicon glyphicon-save"\x3e\x3c/span\x3e\x3c/button\x3e\n            \x3c/uib-tab-heading\x3e\n            \x3cnvd3 data\x3d"stat"\n                  options\x3d"$ctrl.chart_options( key, stat )"\x3e\n            \x3c/nvd3\x3e\n          \x3c/uib-tab\x3e\n        \x3c/uib-tabset\x3e\n      \x3c/div\x3e\n    \x3c/div\x3e\n'});
