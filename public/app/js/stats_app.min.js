var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var a=0;return function(b){return $jscomp.SYMBOL_PREFIX+(b||"")+a++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var b=0;return $jscomp.iteratorPrototype(function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var c=0,d={next:function(){if(c<a.length){var e=c++;return{value:b(e,a[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.values",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a,c){return c})}},"es8","es3");
$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
angular.module("statsApp",["ui.bootstrap","nvd3","angularMoment"]).run(["amMoment",function(a){a.changeLocale("fr")}]).config(["$httpProvider",function(a){a.defaults.withCredentials=!0}]).controller("StatsCtrl",["$scope","$http","$locale","moment","URL_ENT",function(a,b,c,d,e){a.$ctrl=a;a.allowed=!1;b.get(e+"/api/users/current").then(function(g){a.allowed=0<_.chain(g.data.profiles).pluck("type").intersection(["DIR","ADM"]).value().length;a.allowed&&(a.types_labels={global:"Statistiques globales",
structure_id:"\u00c9tablissements",application_id:"Tuiles",profil_id:"Profils utilisateurs",user_id:"Utilisateurs",week_day:"Jour de la semaine"},a.period_types={list:[{label:"jour",value:"day"},{label:"semaine",value:"week"},{label:"mois",value:"month"},{label:"ann\u00e9e",value:"year"}],selected:"week"},a.multibarchart_options={chart:{type:"multiBarChart",height:256,width:1050,margin:{left:50,top:20,bottom:100,right:20},showControls:!1,showValues:!0,showLegend:!0,stacked:!1,duration:500,labelThreshold:.01,
labelSunbeamLayout:!0,rotateLabels:-25,reduceXTicks:!1}},a.multibarhorizontalchart_options=angular.copy(a.multibarchart_options),a.multibarhorizontalchart_options.chart.type="multiBarHorizontalChart",a.multibarhorizontalchart_options.chart.height=512,a.multibarhorizontalchart_options.chart.margin={left:250,top:20,bottom:20,right:50},a.chart_options=function(b,c){switch(b){case "structure_id":case "profil_id":return a.multibarhorizontalchart_options.chart.height=24*c.length*c[0].values.length+40,a.multibarhorizontalchart_options.chart.margin.left=
8*_.chain(c[0].values).pluck("x").map(function(a){return a.length}).max().value(),a.multibarhorizontalchart_options;default:return a.multibarchart_options}},a.retrieve_data=function(g){d();a.fin=a.debut.clone().endOf(a.period_types.selected);a.labels={};a.labels.week_day=angular.copy(c.DATETIME_FORMATS.DAY);a.labels.week_day.push(a.labels.week_day.shift());b.get(e+"/api/profiles_types").then(function(b){a.labels.profil_id=_.chain(b.data).map(function(a){return[a.id,a.name]}).object().value()});b.get(e+
"/api/applications").then(function(b){a.labels.application_id=_.chain(b.data).map(function(a){return[a.id,a.name]}).object().value()});b.get(e+"/api/structures_types").then(function(b){a.structures_types=b.data});b.get(e+"/api/structures",{params:{expand:!1}}).then(function(c){a.labels.structure_id=_.chain(c.data).map(function(a){return[a.id,a.name+" ("+a.id+")"]}).object().value();b.get(e+"/api/logs",{params:{"timestamp\x3e":a.debut.clone().toDate(),"timestamp\x3c":a.fin.clone().toDate(),"structure_id[]":_.chain(a.labels.structure_id).keys().reject(function(a){return _(["0699990Z",
"069BACAS","069DANEZ"]).contains(a)}).value()}}).then(function(b){var c=["structure_id","application_id","profil_id","week_day"],d=function(b,c){return[{key:b,values:_.chain(c).keys().map(function(f){return{key:b,value:f,x:a.labels[b][f],y:c[f]}}).sortBy(function(a){switch(b){case "structure_id":case "profil_id":return-1*a.y;case "week_day":return!0;default:return a.x}}).value()}]},e=function(a,b){return _.chain(b).map(function(b){return[b,d(b,_(a).countBy(b))]}).object().value()};a.logs=b.data;a.filters=
{};a.stats={};a.stats.global=e(a.logs,c);c.forEach(function(b){"week_day"!==b&&(a.stats[b]=_.chain(a.stats.global[b][0].values).pluck("value").map(function(d){return[d,e(_(a.logs).select(function(a){return a[b]===d}),_(c).difference([b]))]}).object().value())});a.stats.global.structure_id.push({key:"utilisateurs uniques",values:_.chain(a.logs).groupBy(function(a){return a.structure_id}).map(function(b,c){return{key:"utilisateurs uniques",x:a.labels.structure_id[c],y:_.chain(b).pluck("user_id").uniq().value().length}}).value()});
a.stats.global.structure_id.push({key:"apps",values:_.chain(a.logs).groupBy(function(a){return a.structure_id}).map(function(b,c){return{key:"apps",x:a.labels.structure_id[c],y:_.chain(b).pluck("application_id").uniq().value().length}}).value()});a.stats.global.profil_id.push({key:"utilisateurs uniques",values:_.chain(a.logs).groupBy(function(a){return a.profil_id}).map(function(b,c){return{key:"utilisateurs uniques",x:a.labels.profil_id[c],y:_.chain(b).pluck("user_id").uniq().value().length}}).value()});
_(a.stats.structure_id).each(function(b,c){b.profil_id.push({key:"utilisateurs uniques",values:_.chain(a.logs).where({structure_id:c}).groupBy(function(a){return a.profil_id}).map(function(b,c){return{key:"utilisateurs uniques",x:a.labels.profil_id[c],y:_.chain(b).pluck("user_id").uniq().value().length}}).value()})})})})},a.decr_period=function(){a.debut.subtract(1,a.period_types.selected+"s");a.retrieve_data(a.debut)},a.incr_period=function(){a.debut.add(1,a.period_types.selected+"s");a.retrieve_data(a.debut)},
a.reset_period=function(){a.debut=d().startOf(a.period_types.selected);a.retrieve_data(a.debut)},a.reset_period())})}]);
