var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,c,f){b!=Array.prototype&&b!=Object.prototype&&(b[c]=f.value)};$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var b=0;return function(c){return $jscomp.SYMBOL_PREFIX+(c||"")+b++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var b=$jscomp.global.Symbol.iterator;b||(b=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[b]&&$jscomp.defineProperty(Array.prototype,b,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(b){var c=0;return $jscomp.iteratorPrototype(function(){return c<b.length?{done:!1,value:b[c++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(b){$jscomp.initSymbolIterator();b={next:b};b[$jscomp.global.Symbol.iterator]=function(){return this};return b};$jscomp.iteratorFromArray=function(b,c){$jscomp.initSymbolIterator();b instanceof String&&(b+="");var f=0,e={next:function(){if(f<b.length){var g=f++;return{value:c(g,b[g]),done:!1}}e.next=function(){return{done:!0,value:void 0}};return e.next()}};e[Symbol.iterator]=function(){return e};return e};
$jscomp.polyfill=function(b,c,f,e){if(c){f=$jscomp.global;b=b.split(".");for(e=0;e<b.length-1;e++){var g=b[e];g in f||(f[g]={});f=f[g]}b=b[b.length-1];e=f[b];c=c(e);c!=e&&null!=c&&$jscomp.defineProperty(f,b,{configurable:!0,writable:!0,value:c})}};$jscomp.polyfill("Array.prototype.values",function(b){return b?b:function(){return $jscomp.iteratorFromArray(this,function(b,f){return f})}},"es8","es3");
$jscomp.polyfill("Array.prototype.keys",function(b){return b?b:function(){return $jscomp.iteratorFromArray(this,function(b){return b})}},"es6","es3");
angular.module("statsApp",["ui.bootstrap","nvd3","angularMoment","chieffancypants.loadingBar"]).run(["amMoment",function(b){b.changeLocale("fr")}]).config(["$httpProvider",function(b){b.defaults.withCredentials=!0}]).component("stats",{controller:["$http","$locale","$q","moment","URL_ENT",function(b,c,f,e,g){var a=this;a.allowed=!1;a.period={decr:function(){a.debut.subtract(1,a.period_types.selected+"s");a.retrieve_data()},incr:function(){a.debut.add(1,a.period_types.selected+"s");a.retrieve_data()},
reset:function(){a.debut=e().startOf(a.period_types.selected);a.retrieve_data()}};a.types_labels={global:"Statistiques globales",structure_id:"\u00c9tablissements",application_id:"Tuiles",profil_id:"Profils utilisateurs",user_id:"Utilisateurs",weekday:"Jours de la semaine",hour:"Heures de la journ\u00e9e"};a.period_types={list:[{label:"jour",value:"day"},{label:"semaine",value:"week"},{label:"mois",value:"month"}],selected:"week"};a.cities={list:[],selected:void 0};a.structures_types={list:[],selected:void 0};
a.multibarchart_options={chart:{type:"multiBarChart",height:256,width:1050,margin:{left:50,top:20,bottom:100,right:20},showControls:!1,showValues:!0,showLegend:!0,stacked:!1,duration:500,labelThreshold:.01,labelSunbeamLayout:!0,rotateLabels:-25,reduceXTicks:!1}};a.multibarhorizontalchart_options=angular.copy(a.multibarchart_options);a.multibarhorizontalchart_options.chart.type="multiBarHorizontalChart";a.multibarhorizontalchart_options.chart.height=512;a.multibarhorizontalchart_options.chart.margin=
{left:250,top:20,bottom:20,right:50};a.chart_options=function(b,h){switch(b){case "structure_id":case "profil_id":return a.multibarhorizontalchart_options.chart.height=24*h.length*h[0].values.length+40,a.multibarhorizontalchart_options.chart.margin.left=8*_.chain(h[0].values).pluck("x").map(function(a){return a.length}).max().value(),a.multibarhorizontalchart_options;default:return a.multibarchart_options}};a.labels={weekday:_.memoize(function(a){var b=angular.copy(c.DATETIME_FORMATS.DAY);b.push(b.shift());
return a+1+" "+b[a]}),hour:function(a){10>a&&(a="0"+a);return a+":00 - "+a+":59"}};a.process_data=function(b){a.logs=_(b).map(function(a){a.timestamp=e(a.timestamp);a.weekday=a.timestamp.day();a.hour=a.timestamp.hour();return a});a.logs_SSO=_(a.logs).where({application_id:"SSO"});a.totals={users:_(a.logs).countBy(function(a){return a.user_id}),profile:_(a.logs).countBy(function(a){return a.profil_id}),connections:a.logs_SSO.length,active_connections:_(a.logs_SSO).select(function(a){var b=e().subtract(4,
"hours");return a.timestamp.isAfter(b)}).length};a.logs=_(a.logs).reject(function(a){return"SSO"==a.application_id});a.log_structures=_.chain(a.logs).pluck("structure_id").uniq().map(function(b){return _(a.structures).findWhere({id:b})}).value();a.log_applications=_.chain(a.logs).pluck("application_id").uniq().map(function(b){return _(a.applications).findWhere({id:b})}).value();a.log_profiles_types=_.chain(a.logs).pluck("profil_id").uniq().map(function(b){return _(a.profiles_types).findWhere({id:b})}).value();
var h=["structure_id","application_id","profil_id","weekday","hour"],d=function(b,d){return[{key:"clicks",values:_.chain(d).keys().map(function(k){return{key:b,value:k,x:a.labels[b](k),y:d[k]}}).sortBy(function(a){switch(b){case "structure_id":case "profil_id":return-1*a.y;default:return a.x}}).value()}]},c=function(a,b){return _.chain(b).map(function(b){return[b,d(b,_(a).countBy(b))]}).object().value()};a.stats={};a.stats.global=c(a.logs,h);a.stats.global.structure_id.push({key:"utilisateurs uniques",
values:_.chain(a.logs).groupBy(function(a){return a.structure_id}).map(function(b,d){return{key:"utilisateurs uniques",x:a.labels.structure_id(d),y:_.chain(b).pluck("user_id").uniq().value().length}}).value()});a.stats.global.structure_id.push({key:"apps",values:_.chain(a.logs).groupBy(function(a){return a.structure_id}).map(function(b,d){return{key:"apps",x:a.labels.structure_id(d),y:_.chain(b).pluck("application_id").uniq().value().length}}).value()});a.stats.global.profil_id.push({key:"utilisateurs uniques",
values:_.chain(a.logs).groupBy(function(a){return a.profil_id}).map(function(b,d){return{key:"utilisateurs uniques",x:a.labels.profil_id(d),y:_.chain(b).pluck("user_id").uniq().value().length}}).value()});h.forEach(function(b){a.stats[b]=_.chain(a.stats.global[b][0].values).pluck("value").map(function(d){return[d,c(_(a.logs).select(function(a){return a[b]===d}),_(h).difference([b]))]}).object().value()});_(a.stats.structure_id).each(function(b,d){b.profil_id.push({key:"utilisateurs uniques",values:_.chain(a.logs).where({structure_id:d}).groupBy(function(a){return a.profil_id}).map(function(b,
d){return{key:"utilisateurs uniques",x:a.labels.profil_id(d),y:_.chain(b).pluck("user_id").uniq().value().length}}).value()})})};a.filter_data=function(b){return _(b).select(function(b){return(void 0==a.structures_types.selected||_.chain(a.structures).where({type:a.structures_types.selected.id}).pluck("id").contains(b.structure_id).value())&&(void 0==a.cities.selected||_.chain(a.structures).where({zip_code:a.cities.selected.zip_code}).pluck("id").contains(b.structure_id).value())})};a.retrieve_data=
function(){a.fin=a.debut.clone().endOf(a.period_types.selected);b.get(g+"/api/logs",{params:{"timestamp\x3e":a.debut.clone().toDate(),"timestamp\x3c":a.fin.clone().toDate()}}).then(function(c){a.raw_logs=c.data;0<a.raw_logs.length&&b.get(g+"/api/structures",{params:{expand:!1,"id[]":_.chain(a.raw_logs).pluck("structure_id").uniq().value()}}).then(function(c){a.structures=c.data;a.labels.structure_id=function(b){var d="",c=_(a.structures).findWhere({id:b});void 0!=c&&(d=c.name);return d+" ("+b+")"};
a.cities.list=_.chain(a.structures).map(function(a){return{zip_code:a.zip_code,city:a.city}}).uniq(function(a){return a.zip_code}).reject(function(a){return null==a.zip_code||""==a.zip_code}).value();return b.get(g+"/api/structures_types",{params:{"id[]":_.chain(a.structures).pluck("type").uniq().value()}})}).then(function(b){a.structures_types.list=b.data}).then(function(){a.process_data(a.filter_data(a.raw_logs))})})};b.get(g+"/api/users/current").then(function(c){a.allowed=0<_.chain(c.data.profiles).pluck("type").intersection(["DIR",
"ADM"]).value().length;a.allowed&&(c=[b.get(g+"/api/profiles_types").then(function(b){a.profiles_types=b.data;a.labels.profil_id=_.memoize(function(b){var c=b;b=_(a.profiles_types).findWhere({id:b});void 0!=b&&(c=b.name);return c})}),b.get(g+"/api/applications").then(function(b){a.applications=b.data;a.labels.application_id=_.memoize(function(b){var c=b;b=_(a.applications).findWhere({id:b});void 0!=b&&(c=b.name);return c})})],f.all(c).then(function(b){a.period.reset()}))})}],template:'\n    \x3cdiv ng:if\x3d"$ctrl.allowed"\x3e\n      \x3ch2\x3e\n        {{ $ctrl.debut | amDateFormat:\'dddd Do MMMM YYYY\' }} - {{ $ctrl.fin | amDateFormat:\'dddd Do MMMM YYYY\' }}\n      \x3c/h2\x3e\n      \x3ch3\x3e\n        \x3cselect ng:options\x3d"period_type.value as period_type.label for period_type in $ctrl.period_types.list"\n                ng:model\x3d"$ctrl.period_types.selected"\n                ng:change\x3d"$ctrl.period.reset()"\x3e\x3c/select\x3e\n        \x3cbutton class\x3d"btn btn-lg" ng:click\x3d"$ctrl.period.reset()"\x3e \u2715 \x3c/button\x3e\n        \x3cbutton class\x3d"btn btn-lg" ng:click\x3d"$ctrl.period.decr()"\x3e \u25c0 \x3c/button\x3e\n        \x3cbutton class\x3d"btn btn-lg" ng:click\x3d"$ctrl.period.incr()"\x3e \u25b6 \x3c/button\x3e\n      \x3c/h3\x3e\n      \x3ch3\x3e\n        \x3cselect ng:options\x3d"city as city.zip_code + \' : \' + city.city for city in $ctrl.cities.list"\n                ng:model\x3d"$ctrl.cities.selected"\n                ng:change\x3d"$ctrl.process_data($ctrl.filter_data($ctrl.raw_logs));"\x3e\x3c/select\x3e\n        \x3cselect ng:options\x3d"st as st.name for st in $ctrl.structures_types.list"\n                ng:model\x3d"$ctrl.structures_types.selected"\n                ng:change\x3d"$ctrl.process_data($ctrl.filter_data($ctrl.raw_logs));"\x3e\x3c/select\x3e\n      \x3c/h3\x3e\n\n      \x3cdiv class\x3d"col-md-12"\n           ng:repeat\x3d"(type, values) in $ctrl.stats"\x3e\n        \x3cdiv class\x3d"panel panel-default"\n             ng:if\x3d"type \x3d\x3d \'global\'"\x3e\n          \x3cdiv class\x3d"panel-heading"\x3e{{$ctrl.types_labels[type]}} {{$ctrl.totals.connections}} connexions dont {{$ctrl.totals.active_connections}} en cours\x3c/div\x3e\n          \x3cdiv class\x3d"panel-body"\x3e\n            \x3cuib-tabset\x3e\n              \x3cuib-tab index\x3d"$index + 1"\n                       ng:repeat\x3d"(key, stat) in values"\n                       heading\x3d"{{stat[0].values.length}} {{$ctrl.types_labels[key]}}"\x3e\n                \x3cnvd3 data\x3d"stat"\n                      options\x3d"$ctrl.chart_options( key, stat )"\x3e\n                \x3c/nvd3\x3e\n              \x3c/uib-tab\x3e\n            \x3c/uib-tabset\x3e\n          \x3c/div\x3e\n        \x3c/div\x3e\n\n        \x3cdiv class\x3d"panel panel-default"\n             ng:if\x3d"type !\x3d\x3d \'global\'"\x3e\n          \x3cdiv class\x3d"panel-heading"\x3eStatistiques par {{$ctrl.types_labels[type]}}\x3c/div\x3e\n          \x3cdiv class\x3d"panel-body"\x3e\n            \x3cuib-tabset\x3e\n              \x3cuib-tab index\x3d"$index + 1"\n                       ng:repeat\x3d"(key, value) in values"\n                       heading\x3d"{{value[0].values.length}} {{$ctrl.labels[type](key)}}"\x3e\n                \x3cuib-tabset\x3e\n                  \x3cuib-tab index\x3d"$index + 1"\n                           ng:repeat\x3d"(subkey, stat) in value"\n                           heading\x3d"{{stat[0].values.length}} {{$ctrl.types_labels[subkey]}}"\x3e\n                    \x3cnvd3 data\x3d"stat"\n                          options\x3d"$ctrl.chart_options( subkey, stat )"\x3e\n                    \x3c/nvd3\x3e\n                  \x3c/uib-tab\x3e\n                \x3c/uib-tabset\x3e\n              \x3c/uib-tab\x3e\n            \x3c/uib-tabset\x3e\n          \x3c/div\x3e\n        \x3c/div\x3e\n      \x3c/div\x3e\n    \x3c/div\x3e\n'});
