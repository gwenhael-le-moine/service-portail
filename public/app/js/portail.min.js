"use strict";angular.module("portailApp",["ngResource","ui.router","ui.bootstrap","as.sortable","ui.checkbox","ngTouch","angularMoment","ngColorPicker","angular-carousel","ngFitText","zxcvbn","toastr"]).config(["$stateProvider","$urlRouterProvider","$locationProvider","APP_PATH",function(e,n){e.state("portail",{url:"/",component:"portail"}).state("app",{url:"/app/:appid",component:"appWrapper",resolve:{appId:["$transition$",function(e){return e.params().appid}]}}),n.otherwise("/")}]).config(["$httpProvider",function(e){e.defaults.useXDomain=!0,e.defaults.withCredentials=!0,e.interceptors.push(["$q","$window",function(e,n){return{responseError:function(e){return 401===e.status&&(n.location.href="/sso/login?ticket=false&service="+encodeURIComponent(n.location.href)),e}}}])}]).run(["$rootScope","log",function(e,n){e.modification=!1,e.$on("$stateChangeSuccess",function(e,t,i){n.add("app"==t.name?i.appid:"PORTAIL",null,null)})}]),angular.module("portailApp").component("appWrapper",{bindings:{appId:"<"},controller:["$stateParams","$sce","currentUser","Annuaire","Tiles","Utils",function(e,n,t,i,a,r){var l=this;l.$onInit=function(){t.get(!0).then(function(e){l.user=e;var t;t=_(l.user.profiles).isEmpty()?i.query_applications():a.query({structure_id:l.user.active_profile().structure_id}).$promise,t.then(function(e){l.app=_(e).findWhere({application_id:l.appId}),_(l.app).isUndefined()&&r.go_home(),l.app.url=n.trustAsResourceUrl(l.app.url)})})}}],template:'\n<div id="app-wrapper">\n    <div class="en-tete container gris4" role="navigation">\n        <logo class="petit logolaclasse gris4 pull-left"\n              user="$ctrl.user"></logo>\n\n        <span class="hidden-xs hidden-sm titre" ng:cloak>{{$ctrl.app.name}}</span>\n\n        <profilactif class="gris4 profil-select-wrapper"\n                     ng:if="$ctrl.user.profiles"\n                     user="$ctrl.user"></profilactif>\n    </div>\n\n    <appiframe url="$ctrl.app.url"\n               class="appiframe"></appiframe>\n</div>\n'}),angular.module("portailApp").component("appiframe",{bindings:{url:"<"},controller:[function(){var e=this;e.$onInit=function(){e.iOS=null!==navigator.userAgent.match(/iPad/i)||null!==navigator.userAgent.match(/iPhone/i)}}],template:'\n<div class="iframe" ng:class="{\'ios\': $ctrl.iOS}">\n    <iframe id="iframe" frameBorder="0"\n            scrolling="{{$ctrl.iOS ? \'no\': \'yes\'}}"\n            ng:src="{{$ctrl.url}}">\n    </iframe>\n</div>\n'}),angular.module("portailApp").directive("fileChanged",function(){return{restrict:"A",link:function(e,n,t){n.bind("change",e.$eval(t.fileChanged))}}}).component("avatar",{controller:["currentUser","URL_ENT","User",function(e,n){var t=this;t.URL_ENT=n,t.processing=!1;var i=function(e,n){var t=new FileReader;t.onload=function(e){n(e.target.result)},t.readAsDataURL(e)},a=function(e){for(var n=e.split(",")[0].indexOf("base64")>=0?atob(e.split(",")[1]):unescape(e.split(",")[1]),t=e.split(",")[0].split(":")[1].split(";")[0],i=new Uint8Array(n.length),a=0;a<n.length;a++)i[a]=n.charCodeAt(a);return new Blob([i],{type:t})},r=function(e){t.processing=!0;var n=256,r=256;i(e,function(e){var i=new Image;t.user.new_avatar.image=e,i.onload=function(){t.user.new_avatar.height=i.height,t.user.new_avatar.width=i.width;var e=1;t.user.new_avatar.width>r&&(e=r/i.width,t.user.new_avatar.width=r,t.user.new_avatar.height=i.height*e),t.user.new_avatar.height>n&&(e=n/i.height,t.user.new_avatar.height=n,t.user.new_avatar.width=i.width*e);var l=document.createElement("canvas");l.width=t.user.new_avatar.width,l.height=t.user.new_avatar.height,l.getContext("2d").drawImage(i,0,0,t.user.new_avatar.width,t.user.new_avatar.height),t.user.new_avatar.image=l.toDataURL(),t.user.new_avatar.blob=a(t.user.new_avatar.image)},i.src=t.user.new_avatar.image,t.processing=!1})};t.onChange=function(e){r(e.target.files[0])};var l=function(){t.user.new_avatar={image:null,blob:null,width:0,height:0}};t.upload_avatar=function(){t.user.$upload_avatar().then(function(){l()})},t["delete"]=function(){t.user.avatar="empty",t.user.$update()},t.$onInit=function(){e.get(!1).then(function(e){t.user=e,l()})}}],template:'\n<div class="avatar">\n    <img draggable="false" class="svg"\n         ng:src="{{$ctrl.user.new_avatar.image ? $ctrl.user.new_avatar.image : $ctrl.URL_ENT + \'/\' + $ctrl.user.avatar}}" />\n    <button style="position: absolute; top: 0; right: 0;"\n            title="Supprimer l\'avatar existant"\n            ng:if="!$ctrl.user.new_avatar.blob"\n            ng:click="$ctrl.delete()">\n        <span class="glyphicon glyphicon-remove"\n              style="color: red;" ></span>\n    </button>\n\n    <input type="file" file-changed="$ctrl.onChange" ng:if="!$ctrl.processing"/>\n    <span ng:if="$ctrl.processing"><i class="fa fa-spinner fa-pulse"></i> traitement</span>\n    <footer>\n        <button ng:disabled="!$ctrl.user.new_avatar.blob"\n                ng:click="$ctrl.upload_avatar()">Valider l\'avatar</button>\n    </footer>\n</div>\n'}),angular.module("portailApp").component("helpIcon",{bindings:{user:"<"},controller:["CONFIG",function(e){var n=this;n.$onInit=function(){n.help_links=_(e.help_links).select(function(e){return!_(n.user.profiles).isEmpty()&&_(e.profils).intersection(_(n.user.profiles).pluck("type")).length>0})}}],template:'\n<div uib-dropdown\n     keyboard-nav\n     ng:if="$ctrl.help_links.length > 0">\n    <a class="uib-dropdown-toggle" uib-dropdown-toggle><h2>?</h2> </a>\n    <ul class="dropdown-menu" uib-dropdown-menu role="menu" aria-labelledby="simple-btn-keyboard-nav">\n        <li ng:repeat="link in $ctrl.help_links">\n            <a ng:href="{{link.url}}" target="_blank">{{link.title}}</a>\n        </li>\n    </ul>\n</div>\n'}),angular.module("portailApp").component("logo",{bindings:{user:"="},controller:["Utils","APP_PATH",function(e,n){var t=this;t.prefix=n,t.go_home=function(){t.user.edit_profile=!1,e.go_home()}}],template:'<a ng:click="$ctrl.go_home()">    <img draggable="false" ng:src="{{$ctrl.prefix}}/app/node_modules/laclasse-common-client/images/logolaclasse.svg" />    <h3 class="hidden-xs hidden-sm ent-name">laclasse.com</h3></a>'}),angular.module("portailApp").component("news",{bindings:{edition:"<"},controller:["$sce","Popups","$http","$q","URL_ENT","RANDOM_IMAGES","currentUser",function(e,n,t,i,a,r,l){var o=this;o.newsfeed=[],o.retrieve_news=function(){var n=moment().subtract(1,"months").toDate().toISOString();t.get(a+"/api/news",{params:{user_id:o.user.id,"pubDate>":n}}).then(function(r){return o.newsfeed=_(r.data).map(function(n){return n.trusted_content=e.trustAsHtml(n.description),n.no_image=_(n.image).isNull(),n.pubDate=moment(new Date(n.pubDate)).toDate(),n.image="app/node_modules/laclasse-common-client/images/11_publipostage.svg",n}),o.carouselIndex=0,_(o.user.profiles).isEmpty()?i.resolve({data:[]}):t.get(a+"/api/structures/"+o.user.active_profile().structure_id+"/rss",{params:{"pubDate>":n}})}).then(function(n){o.newsfeed=o.newsfeed.concat(_(n.data).map(function(n){return n.trusted_content=e.trustAsHtml(n.content),n.no_image=_(n.image).isNull(),n.pubDate=moment(new Date(n.pubDate)).toDate(),_(n.image).isNull()&&(n.image=_(r).sample()),n}))})},o.config_news_fluxes=function(){n.manage_fluxes(function(){o.retrieve_news(!0)},function(){})},o.$onInit=function(){l.get(!1).then(function(e){o.user=e,o.retrieve_news(!1)})}}],template:'\n<ul class="noir" rn-carousel rn-carousel-buffered rn-carousel-auto-slide="6" rn-carousel-index="$ctrl.carouselIndex">\n    <li ng:repeat="slide in $ctrl.newsfeed | orderBy:\'pubDate\':true" active="slide.active"\n        ng:class="{\'publipostage\': slide.title == \'Publipostage\', \'no-image\': slide.no_image}">\n        <div class="carousel-image"\n             ng:style="{\'background-image\': \'url(\' + slide.image + \')\'}"></div>\n        <div class="carousel-caption">\n            <span class="pub-date" ng:cloak>{{ slide.pubDate | date:\'medium\' }}</span>\n            <a href="{{ slide.link }}" target="_blank" ng:if="slide.link != \'notYetImplemented\'">\n                <h6 ng:cloak>{{ slide.title }}</h6>\n            </a>\n            <h6 ng:if="slide.link == \'notYetImplemented\'">{{ slide.title }}</h6>\n            <p ng:bind-html="slide.trusted_content"></p>\n        </div>\n    </li>\n    <div class="hidden-xs hidden-sm angular-carousel-indicators"\n         rn-carousel-indicators\n         slides="$ctrl.newsfeed"\n         rn-carousel-index="$ctrl.carouselIndex">\n    </div>\n    <span class="hidden-xs hidden-sm floating-button big toggle bouton-config-news blanc"\n          ng:if="$ctrl.user.is_admin() && $ctrl.edition"\n          ng:click="$ctrl.config_news_fluxes()"></span>\n</ul>\n'}),angular.module("portailApp").component("portail",{controller:["$sce","$state","$uibModal","$q","CASES","COULEURS","currentUser","Utils","CCN","Tiles","APP_PATH","CACHE_BUSTER","User","Annuaire","URL_ENT","Popups",function(e,n,t,i,a,r,l,o,s,c,u,p,d,m,g,f){var h=this;h.$onInit=function(){l.get(!0).then(function(e){h.user=e,h.prefix=u,h.COULEURS=r,h.CACHE_BUSTER=p,h.get_tile_template=function(e){return{app:"app/views/tile_app.html?v="+p,back:"app/views/tile_app.html?v="+p,regroupement:"app/views/tile_regroupement.html?v="+p,eleve:"app/views/tile_eleve.html?v="+p,rn:"app/views/tile_rn.html?v="+p,ccn:"app/views/tile_ccn.html?v="+p}[e]},h.filter_criteria={};var t={index:0,taxonomy:"back",name:"\u2190 Retour",description:"Retour",color:"gris3",action:function(){h.tree=h.tiles,h.parent=null}},d=function(e){var i=function(e){var n=angular.copy(t);return n.action=e.action,n},r=function(){return function(){return!0}},c={CCNUM:{action:function(){h.modification||(h.tree={configurable:!1,filter:r,aside_template:"app/views/aside_CCNUM.html?v="+p,tiles:o.pad_tiles_tree([t].concat(s.query().map(function(n,t){return n.taxonomy="ccn",n.index=t+1,_(n).has("leaves")&&(n.action=function(){h.tree={configurable:!1,filter:r,aside_template:"app/views/aside_CCNUM_archives.html?v="+p,tiles:[i(e)].concat(n.leaves.map(function(e,n){return e.taxonomy="ccn",e.index=n+1,e}))},h.parent=n}),n})))},h.parent=e)}},GAR:{action:function(){h.modification||l.ressources().then(function(n){h.tree={configurable:!1,filter:r,aside_template:"app/views/aside_RN.html?v="+p,tiles:o.pad_tiles_tree([t].concat(n.map(function(e,n){return e.taxonomy="rn",e.index=n+1,e.icon=u+"/app/node_modules/laclasse-common-client/images/"+("MANUEL"===e.type?"05_validationcompetences.svg":"AUTRE"===e.type?"07_blogs.svg":"08_ressources.svg"),e.color=a[n%16].color,e.action=function(){o.log_and_open_link("GAR",e.url)},e})))},h.parent=e})}},TROMBI:{action:function(){h.modification||(h.filter_criteria={show_classes:!0,show_groupes_eleves:!0,show_groupes_libres:!0,text:""},h.get_structure=function(e){return m.get_structure(e).then(function(e){return e.data})},l.groups().then(function(n){h.tree={configurable:!1,filter:function(){return function(e){return"back"===e.taxonomy||("regroupement"!==e.taxonomy||_(h.filter_criteria).has("show_classes")&&h.filter_criteria.show_classes&&"CLS"===e.type||_(h.filter_criteria).has("show_groupes_eleves")&&h.filter_criteria.show_groupes_eleves&&"GRP"===e.type||_(h.filter_criteria).has("show_groupes_libres")&&h.filter_criteria.show_groupes_libres&&"GPL"===e.type)&&(!_(e).has("name")||_(h.filter_criteria.text).isEmpty()||e.name.toUpperCase().includes(h.filter_criteria.text.toUpperCase())||!_(e).has("structure")||_(h.filter_criteria.text).isEmpty()||e.structure.name.toUpperCase().includes(h.filter_criteria.text.toUpperCase()))}},aside_template:"app/views/aside_TROMBI_regroupements.html?v="+p,tiles:o.pad_tiles_tree([t].concat(n.map(function(n,t){switch(n.taxonomy="regroupement",n.index=t+1,n.type){case"CLS":n.color="vert";break;case"GRP":n.color="bleu";break;default:n.color="jaune"}return n.color+=t%2==0?"":"-moins",n.action=function(){h.filter_criteria.text="",m.get_users(_(n.users).pluck("user_id")).then(function(n){h.tree={configurable:!1,filter:function(){return function(e){return"eleve"!==e.taxonomy||_(h.filter_criteria.text).isEmpty()||e.lastname.toUpperCase().includes(h.filter_criteria.text.toUpperCase())||e.firstname.toUpperCase().includes(h.filter_criteria.text.toUpperCase())}},aside_template:"app/views/aside_TROMBI_people.html?v="+p,tiles:o.pad_tiles_tree([i(e)].concat(n.data.map(function(e,n){return e.taxonomy="eleve",e.index=n+1,e.color="jaune",e.color+=n%2==0?"":"-moins",e.avatar=(_(e.avatar.match(/^(user|http)/)).isNull()?g+"/":"")+e.avatar,e})))},h.parent=e})},n})))},h.parent=e}))}}};return e.configure=!1,e.toggle_configure=function(){h.tree.tiles.forEach(function(n){n.configure=n.index===e.index&&!n.configure})},e.dirty={},e.is_dirty=function(n){e.dirty[n]=!0},e.to_delete=!1,e.remove=function(){e.to_delete=!e.to_delete,e.dirty=e.dirty||e.to_delete,e.configure=!1},!_(c[e.application_id]).isUndefined()&&_(c[e.application_id]).has("action")?e.action=c[e.application_id].action:e.action=function(){h.modification||("EXTERNAL"===e.type||_(e.application_id).isNull()||"PRONOTE"===e.application_id?o.log_and_open_link("PRONOTE"===e.application_id?"PRONOTE":"EXTERNAL",e.url):n.go("app",{appid:e.application_id}))},e},v=function(){l.tiles().then(function(e){e.forEach(function(e){e.taxonomy="app"});var n=_(e).select(function(e){return(!(7==moment().month())||e.summer||!_(h.user.profiles).isEmpty()&&!_(["ELV","TUT"]).includes(h.user.active_profile().type))&&(!h.user.profiles||!h.user.active_profile()||h.user.is_admin()||!_(e.hidden).includes(h.user.active_profile().type))&&("MAIL"!==e.application_id||_.chain(h.user.emails).pluck("type").includes("Ent").value())}).map(d);n=o.fill_empty_tiles(n),n=_(n).sortBy(function(e){return e.index}),n=o.pad_tiles_tree(n),h.tiles={configurable:!0,aside_template:"app/views/aside_news.html?v="+p,tiles:n},t.action()})};h.modification=!1,h.edit_tiles=function(){h.modification=!0},h.exit_tiles_edition=function(){h.modification=!1,v()};var b=function(){_(h.tree.tiles).each(function(e,n){e.index=n,_(e).has("dirty")||(e.dirty={}),e.dirty.index=!0})};h.sortable_options={accept:function(){return!0},longTouch:!0,itemMoved:b,orderChanged:b,containment:".damier",containerPositioning:"relative",additionalPlaceholderClass:"col-xs-6 col-sm-4 col-md-3 col-lg-3 petite case",clone:!1,allowDuplicates:!1},h.add_tile=function(e){f.add_tiles(e,function(n){i.all(_(n).map(function(n){var t=_(e).findIndex(function(e){return!_(e).has("taxonomy")});-1===t&&(t=e.length,e.push({index:t})),e[t]=d(n),e[t].index=t,_(n).has("id")||(e[t].to_create=!0)}))},function(){})},h.save_tiles_edition=function(){var e=[];e.concat(_.chain(h.tree.tiles).where({to_delete:!0}).map(function(e){switch(e.taxonomy){case"app":return c["delete"]({id:e.id}).$promise;case"rn":default:return console.log(e),null}})),e.concat(_.chain(h.tree.tiles).select(function(e){return _(e).has("id")&&!_(e).has("to_create")&&_(e).has("dirty")&&!_(e.dirty).isEmpty()}).map(function(e){switch(e.taxonomy){case"app":var n={};return _.chain(e.dirty).keys().each(function(t){n[t]=e[t]}),c.update({id:e.id},n);case"rn":default:return console.log(e),null}})),e.concat(_.chain(h.tree.tiles).where({to_create:!0}).map(function(e){switch(e.taxonomy){case"app":return e.structure_id=h.user.active_profile().structure_id,c.save({},e).$promise;case"rn":default:return console.log(e),null}})),i.all(e).then(function(){h.tree.tiles=o.fill_empty_tiles(_(h.tree.tiles).reject(function(e){return e.to_delete}))}),h.modification=!1,h.tree.tiles.forEach(function(e){_(e).has("configure")&&(e.configure=!1)})},v()})}}],template:'\n<div class="row portail"\n     ng:if="$ctrl.user">\n    <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 aside">\n        <help-icon class="btn-group hidden-xs help-icon"\n                   user="$ctrl.user"></help-icon>\n\n        <logo class="col-xs-1 col-sm-1 col-md-6 col-lg-6 logolaclasse gris4"\n              user="$ctrl.user"></logo>\n\n        <user-tile user="$ctrl.user"></user-tile>\n\n        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 hidden-xs hidden-sm aside-bottom"\n             ng:include="$ctrl.user.edit_profile ? \'app/views/aside_news.html?v=\' + $ctrl.CACHE_BUSTER : $ctrl.tree.aside_template"></div>\n    </div>\n\n    <div class="col-xs-12 col-sm-12 col-md-8 col-lg-8">\n        <div class="row user-profil"\n             ng:if="$ctrl.user.edit_profile">\n            <user-profile user="$ctrl.user"></user-profile>\n        </div>\n\n        <div class="row damier gris4"\n             ng:class="{\'modification\': $ctrl.modification}"\n             ng:if="!$ctrl.user.edit_profile">\n\n            <ul data-as-sortable="$ctrl.sortable_options"\n                data-is-disabled="!$ctrl.modification"\n                ng:model="$ctrl.tree.tiles">\n\n                <li ng:repeat="tile in $ctrl.tree.tiles | filter:$ctrl.tree.filter() | orderBy:\'index\'"\n                    class="col-xs-6 col-sm-4 col-md-3 col-lg-3 petite case animate scale-fade-in {{tile.color}}"\n                    data-as-sortable-item\n                    ng:class="{ \'empty hidden-xs\': !tile.taxonomy }">\n                    <div ng:include="$ctrl.get_tile_template( tile.taxonomy )"></div>\n                </li>\n            </ul>\n\n            <!-- Mode normal -->\n            <span class="hidden-xs hidden-sm floating-button toggle big off blanc"\n                  ng:if="$ctrl.tree.configurable && $ctrl.user.is_admin() && !$ctrl.modification"\n                  ng:click="$ctrl.edit_tiles()"></span>\n\n            <!-- Mode modification -->\n            <span class="hidden-xs hidden-sm floating-button toggle big on gris4"\n                  ng:if="$ctrl.modification"></span>\n            <span class="floating-button small cancel gris3"\n                  ng:if="$ctrl.modification"\n                  ng:click="$ctrl.exit_tiles_edition()"></span>\n            <span class="floating-button small save gris1"\n                  ng:if="$ctrl.modification"\n                  ng:click="$ctrl.save_tiles_edition()"></span>\n\n            <span class="floating-button small action1 add-app gris1"\n                  ng:if="$ctrl.modification"\n                  ng:click="$ctrl.add_tile( $ctrl.tree.tiles )"></span>\n        </div>\n\n    </div>\n</div>\n'}),angular.module("portailApp").component("profilactif",{bindings:{user:"<"},controller:["Annuaire","$state","$stateParams","currentUser",function(e,n,t,i){var a=this;a.apply_change=function(){i.activate_profile(a.current_profile.id).then(function(){n.transitionTo(n.current,t,{reload:!0,inherit:!0,notify:!0})})},a.$onInit=function(){a.user.profiles.forEach(function(n){e.get_structure(n.structure_id).then(function(e){n.structure=e.data}),e.get_profile_type(n.type).then(function(e){n.profile=e.data})}),a.current_profile=a.user.active_profile()}}],template:'\n<select ng:disabled="$ctrl.user.profiles.length <= 1"\n        ng:model="$ctrl.current_profile"\n        ng:change="$ctrl.apply_change()"\n        ng:options="profile as profile.structure.name + \' : \' + profile.profile.name group by profile.structure.name for profile in $ctrl.user.profiles track by profile.id" >\n</select>\n'}),angular.module("portailApp").component("userProfile",{bindings:{user:"="},controller:["toastr","currentUser","APP_PATH","Utils","User",function(e,n,t,i,a){var r=this;r.dirty={},r.prefix=t,r.groups=[{ouvert:!0,enabled:!0},{ouvert:!0,enabled:!0}],r.password={new1:"",new2:""},r.open_datepicker=function(e){e.preventDefault(),e.stopPropagation()},r.mark_as_dirty=function(e){r.dirty[e]=!0},r.filter_emails=function(){return function(e){return("TUT"!==r.user.active_profile().type||"Ent"!==e.type)&&_(e.asdress.match(e.user_id)).isNull()}},r.save=function(){if(!_(r.dirty).isEmpty()&&(_(r.password.new1).isEmpty()||!_(r.password.new1).isEmpty()&&r.password.new1===r.password.new2)){var n={};_(r.dirty).keys().forEach(function(e){n[e]=r.user[e]}),_(r.password.new1).isEmpty()?delete n.password:n.password=r.password.new1,_(n).isEmpty()||a.update({id:r.user.id},n).$promise.then(function(){e.success("Mise \xe0 jour effectu\xe9e.")},function(){})}},r.$onInit=function(){r.user.editable=_(r.user.aaf_jointure_id).isNull(),r.user.birthdate=new Date(r.user.birthdate)}}],template:'\n<header>\n    <h3>Profil utilisateur</h3>\n    <h1>{{$ctrl.user.firstname}} {{$ctrl.user.lastname}}</h1>\n</header>\n<div class="form">\n    <form>\n        <div class="avatar-container form-group col-md-4 col-xs-12 pull-right">\n            <label>Avatar :</label>\n            <avatar></avatar>\n        </div>\n\n        <accordion close-others="false" class="col-md-8 col-xs-12 pull-left">\n\n            <accordion-group data-is-open="$ctrl.groups[ 0 ].ouvert" ng:if="$ctrl.groups[ 0 ].enabled">\n                <accordion-heading>\n                    <span class="glyphicon" ng:class="{\'glyphicon-chevron-down\': $ctrl.groups[ 0 ].ouvert, \'glyphicon-chevron-right\': !$ctrl.groups[ 0 ].ouvert}"></span> Informations\n                </accordion-heading>\n                <div class="row">\n\n                    <div class="form-group col-md-6 col-xs-12">\n                        <label for="nom">Nom :</label>\n                        <input type="text"\n                               id="nom"\n                               class="form-control"\n                               ng:disabled="!$ctrl.user.editable"\n                               ng:change="$ctrl.mark_as_dirty( \'lastname\' )"\n                               ng:model="$ctrl.user.lastname">\n                    </div>\n                    <div class="form-group col-md-6 col-xs-12">\n                        <label for="prenom">Pr\xe9nom :</label>\n                        <input type="text"\n                               id="prenom"\n                               class="form-control"\n                               ng:disabled="!$ctrl.user.editable"\n                               ng:change="$ctrl.mark_as_dirty( \'firstname\' )"\n                               ng:model="$ctrl.user.firstname">\n                    </div>\n                    <div class="form-group col-md-6 col-xs-12">\n                        <label for="datenaissance">Date de naissance :</label>\n                        <input type="text"\n                               id="date_naissance"\n                               class="form-control"\n                               disabled\n                               value="{{$ctrl.user.birthdate | amDateFormat: \'LL\'}}"\n                               ng:if="!$ctrl.user.editable" />\n                        <div uib-dropdown\n                             id="datenaissance"\n                             class="dropdown form-control date-naissance"\n                             ng:if="$ctrl.user.editable">\n                            <a uib-dropdown-toggle\n                               class="dropdown-toggle"\n                               role="button"\n                               data-toggle="uib-dropdown"\n                               data-target="#"\n                               href>{{$ctrl.user.birthdate | amDateFormat: \'LL\'}}</a>\n                            <div uib-dropdown-menu\n                                 class="dropdown-menu"\n                                 role="menu"\n                                 ng:click="$event.stopImmediatePropagation()">\n                                <div uib-datepicker\n                                     datepicker-options="datepicker_options"\n                                     ng:disabled="!$ctrl.user.editable"\n                                     ng:change="$ctrl.mark_as_dirty( \'birthdate\' )"\n                                     ng:model="$ctrl.user.birthdate"\n                                     ng:required="true">\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class="form-group col-md-6 col-xs-12">\n                        <label for="adresse">Adresse :</label>\n                        <input type="text"\n                               id="adresse"\n                               class="form-control"\n                               ng:disabled="!$ctrl.user.editable"\n                               ng:change="$ctrl.mark_as_dirty( \'address\' )"\n                               ng:model="$ctrl.user.address">\n                    </div>\n                    <div class="form-group col-md-6 col-xs-12">\n                        <label for="codepostal">Code postal :</label>\n                        <input type="text"\n                               id="codepostal"\n                               class="form-control"\n                               ng:disabled="!$ctrl.user.editable"\n                               ng:change="$ctrl.mark_as_dirty( \'zip_code\' )"\n                               ng:model="$ctrl.user.zip_code">\n                    </div>\n                    <div class="form-group col-md-6 col-xs-12">\n                        <label for="ville">Ville :</label>\n                        <input type="text"\n                               id="ville"\n                               class="form-control"\n                               ng:disabled="!$ctrl.user.editable"\n                               ng:change="$ctrl.mark_as_dirty( \'city\' )"\n                               ng:model="$ctrl.user.city">\n                    </div>\n\n                    <div class="form-group col-md-6 col-xs-12"\n                         ng:repeat="email in $ctrl.user.emails | orderBy:\'primary\':true | filter:filter_emails()">\n                        <label for="courriel">Courriel <span ng:if="email.primary">principal</span> :</label>\n                        <input type="text"\n                               id="courriel"\n                               class="form-control"\n                               ng:disabled="true"\n                               ng:model="email.address">\n                    </div>\n                </div>\n\n            </accordion-group>\n\n            <accordion-group data-is-open="$ctrl.groups[ 1 ].ouvert" ng:if="$ctrl.groups[ 1 ].enabled">\n                <accordion-heading>\n                    <span class="glyphicon" ng:class="{\'glyphicon-chevron-down\': $ctrl.groups[ 1 ].ouvert, \'glyphicon-chevron-right\': !$ctrl.groups[ 1 ].ouvert}"></span> Mot de passe<span style="font-weight: bold; color: rgba(235,84,84,0.75)" ng:if="$ctrl.user.default_password">, pensez \xe0 le changer...</span>\n                </accordion-heading>\n                <div class="row">\n                    <div class="form-group col-md-6 col-xs-12">\n                        <label for="newpasswd1">Nouveau mot de passe :</label>\n                        <input type="password" class="form-control" id="newpasswd1"\n                               ng:change="$ctrl.mark_as_dirty( \'password\' )"\n                               ng:model="$ctrl.password.new1"\n                               zxcvbn="passwordStrength"\n                               zx-min-score="2">\n                        <div class="password-strength"\n                             ng:if="$ctrl.dirty.password && $ctrl.password.new1 !== \'\'">\n                            <label>Qualit\xe9 du mot de passe :</label>\n                            <uib-progressbar max="5" value="passwordStrength.score + 1"\n                                             type="{{ ( passwordStrength.score < 2 ) ? \'danger\' : ( ( passwordStrength.score < 3 ) ? \'warning\' : ( ( passwordStrength.score < 4 ) ? \'primary\' : \'success\' ) ) }}">\n                                <span ng:switch="passwordStrength.score">\n                                    <span style="color:white; white-space:nowrap;" ng:switch-when="0">Trop faible</span>\n                                    <span style="color:white; white-space:nowrap;" ng:switch-when="1">Faible</span>\n                                    <span style="color:white; white-space:nowrap;" ng:switch-when="2">Moyen</span>\n                                    <span style="color:white; white-space:nowrap;" ng:switch-when="3">Bon</span>\n                                    <span style="color:white; white-space:nowrap;" ng:switch-when="4">Excellent</span>\n                                </span>\n                            </uib-progressbar>\n                        </div>\n                    </div>\n                    <div class="form-group col-md-6 col-xs-12"\n                         ng:class="{\'has-error\': $ctrl.password.new1 !== $ctrl.password.new2 }">\n                        <label for="newpasswd2">Confirmer le nouveau mot de passe :</label>\n                        <input type="password" class="form-control" id="newpasswd2"\n                               ng:model="$ctrl.password.new2">\n                    </div>\n                </div>\n            </accordion-group>\n\n            <footer>\n                <button ng:click="$ctrl.save()">Enregistrer</button>\n            </footer>\n        </accordion>\n    </form>\n</div>\n'}),angular.module("portailApp").component("userTile",{bindings:{user:"<"},controller:["APP_PATH","URL_ENT",function(e,n){var t=this;t.APP_PATH=e,t.change_password_message="Pensez \xe0 changer votre mot de passe...",t.edit_profile=function(){t.user.edit_profile=!t.user.edit_profile},t.$onInit=function(){t.url_avatar=n+"/"+t.user.avatar}}],template:'\n<div class="col-xs-11 col-sm-11 col-md-6 col-lg-6 user"\n     ng:style="{ \'background-image\': \'url(\' + $ctrl.url_avatar + \')\' }">\n    <div class="user-info-bg">\n        <span class="user-info">\n            <a href style="text-decoration: none;" ng:click="$ctrl.edit_profile()">\n                <h4 class="hidden-xs hidden-sm full-name">{{$ctrl.user.firstname}} {{$ctrl.user.lastname}}\n                    <sup ng:if="$ctrl.user.default_password"><span class="glyphicon glyphicon-alert default-password" aria-hidden="true" data-descr="{{$ctrl.change_password_message}}"></span></sup>\n                </h4>\n                <h4 class="hidden-md hidden-lg initiales">{{$ctrl.user.firstname[0]}}{{$ctrl.user.lastname[0]}}</h4>\n            </a>\n            <profilactif class="gris4"\n                         ng:if="$ctrl.user.profiles"\n                         user="$ctrl.user"></profilactif>\n            <a class="btn hidden-xs hidden-sm logout" ng:href="/sso/logout" title="D\xe9connexion de Laclasse.com">se d\xe9connecter</a>\n        </span>\n    </div>\n</div>\n'}),angular.module("portailApp").constant("CASES",[{color:"bleu"},{color:"jaune"},{color:"violet"},{color:"vert"},{color:"rouge"},{color:"vert"},{color:"bleu"},{color:"jaune"},{color:"violet"},{color:"bleu"},{color:"jaune"},{color:"rouge"},{color:"jaune"},{color:"rouge"},{color:"vert"},{color:"violet"}]).constant("COULEURS",["#1aa1cc","#80ba66","#eb5454","#9c75ab","#e8c254"]).factory("RANDOM_IMAGES",["APP_PATH",function(e){return[e+"/app/node_modules/laclasse-common-client/images/logolaclasse.svg",e+"/app/node_modules/laclasse-common-client/images/random/20150116_102448.jpg",e+"/app/node_modules/laclasse-common-client/images/random/20150204_152946.jpg"]}]),angular.module("portailApp").factory("Flux",["$resource","URL_ENT",function(e,n){return e(n+"/api/flux/:id",{id:"@id",structure_id:"@structure_id",url:"@url",name:"@name"},{get:{isArray:!0},update:{method:"PUT"}})}]),angular.module("portailApp").factory("RessourceNumerique",["$resource","URL_ENT",function(e,n){return e(n+"api/structures/:id/ressources/:ressource_id",{id:"@id",ressource_id:"@ressource_id",ressource_num_id:"@ressource_num_id",date_deb_abon:"@date_deb_abon",date_fin_abon:"@date_fin_abon"},{query_default:{methode:"GET",url:n+"api/ressources/",isArray:!0}})}]),angular.module("portailApp").factory("Tiles",["$resource","URL_ENT","CONFIG",function(e,n,t){return e(n+"/api/tiles/:id",{id:"@id",structure_id:"@structure_id",application_id:"@application_id",index:"@index",type:"@type",name:"@name",description:"@description",url:"@url",icon:"@icon",color:"@color"},{update:{method:"PUT"},query:{method:"GET",cache:!1,isArray:!0,transformResponse:function(e){return _(angular.fromJson(e)).map(function(e){return _(t.apps["default"][e.application_id]).isUndefined()?e:_(t.apps["default"][e.application_id]).extend(e)})}}})}]),angular.module("portailApp").factory("User",["$resource","URL_ENT",function(e,n){var t=e(n+"/api/users/:id",{id:"@id",firstname:"@firstname",lastname:"@lastname",gender:"@gender",birthdate:"@birthdate",address:"@address",zip_code:"@zip_code",city:"@city",password:"@password"},{get:{cache:!1},update:{method:"PUT"},upload_avatar:{method:"POST",url:n+"/api/users/:id/upload/avatar",transformRequest:function(e){var n=new FormData;return n.append("image",e.new_avatar.blob,"new_avatar.png"),
n.append("fileFormDataName","image"),delete e.new_avatar,n},headers:{"Content-Type":undefined}}});return t.prototype.active_profile=function(){return _(this.profiles).findWhere({active:!0})},t.prototype.is_admin=function(){return _(this).has("super_admin")&&this.super_admin||!_(this.profiles).isEmpty()&&(!_.chain(this.profiles).findWhere({structure_id:this.active_profile().structure_id,type:"DIR"}).isUndefined().value()||!_.chain(this.profiles).findWhere({structure_id:this.active_profile().structure_id,type:"ADM"}).isUndefined().value())},t}]),angular.module("portailApp").service("CCN",["Utils","currentUser",function(e,n){this.query=function(){var t=[{nom:"14-18",description:"14-18",icon:"/app/node_modules/laclasse-common-client/images/thematiques/icon_14-18.svg",color:"jaune",action:function(){e.log_and_open_link("CCN","http://14-18.laclasse.com/?url=spip.php%3Fpage%3Dsommaire&cicas=oui")}},{nom:"Z\xe9rogaspi",description:"Z\xe9rogaspi",icon:"/app/node_modules/laclasse-common-client/images/thematiques/icon_zero-gaspi.svg",color:"bleu",action:function(){e.log_and_open_link("CCN","http://zerogaspi.laclasse.com/?url=spip.php%3Fpage%3Dsommaire&cicas=oui")}},{nom:"AIR",description:"Assises du Roman",icon:"/app/node_modules/laclasse-common-client/images/thematiques/icon_air-2014.svg",color:"jaune",action:function(){e.log_and_open_link("CCN","http://air.laclasse.com/?url=spip.php%3Fpage%3Dsommaire&cicas=oui")}},{nom:"Habiter",description:"Repr\xe9sentations cartographiques de l'espace v\xe9cu",icon:"/app/node_modules/laclasse-common-client/images/thematiques/icon_habiter.svg",color:"vert",action:function(){e.log_and_open_link("CCN","http://habiter.laclasse.com/?url=spip.php%3Fpage%3Dsommaire&cicas=oui")}},{nom:"Code",description:"Mener un projet de code cr\xe9atif avec sa classe et r\xe9aliser un jeu en r\xe9seau",icon:"/app/node_modules/laclasse-common-client/images/thematiques/icon_code.svg",color:"orange-brillant",action:function(){e.log_and_open_link("CCN","http://code.laclasse.com/?url=spip.php%3Fpage%3Dsommaire&cicas=oui")}},{nom:"Polar / Krimi",description:"Ecrire un roman illustr\xe9 franco-allemand avec un auteur de polar et un illustrateur, en collaboration avec des coll\xe9giens allemands",icon:"/app/node_modules/laclasse-common-client/images/thematiques/icon_krimi.svg",color:"bleu-fonce",action:function(){e.log_and_open_link("CCN","http://krimi.laclasse.com/?url=spip.php%3Fpage%3Dsommaire&cicas=oui")}},{nom:"Projets archiv\xe9s",description:"Projets archiv\xe9s",icon:"/app/node_modules/laclasse-common-client/images/06_thematiques.svg",color:"gris1",leaves:[{nom:"Th\xe9\xe2tre",description:"Th\xe9\xe2tre",icon:"/app/node_modules/laclasse-common-client/images/thematiques/icon_theatre.svg",color:"rouge",action:function(){e.log_and_open_link("CCN","http://theatre.laclasse.com/?url=spip.php%3Fpage%3Dsommaire&cicas=oui")}},{nom:"Philo",description:"Philo",action:function(){e.log_and_open_link("CCN","http://philo.laclasse.com/?url=spip.php%3Fpage%3Dsommaire&cicas=oui")},icon:"/app/node_modules/laclasse-common-client/images/thematiques/icon_philo.svg",color:"violet"},{color:"gris2",icon:"/app/node_modules/laclasse-common-client/images/thematiques/icon_miam.svg",nom:"Miam",titre:"",action:function(){e.log_and_open_link("CCN","http://miam.laclasse.com/?url=spip.php%3Fpage%3Dsommaire&cicas=oui")}},{color:"bleu",icon:"/app/node_modules/laclasse-common-client/images/thematiques/icon_odysseespatiale.svg",nom:"Odyss\xe9e spatiale",titre:"",action:function(){e.log_and_open_link("CCN","http://novaterra.laclasse.com/?url=spip.php%3Fpage%3Dsommaire&cicas=oui")}},{color:"jaune",icon:"/app/node_modules/laclasse-common-client/images/thematiques/icon_archeologie.svg",nom:"Arch\xe9ologie",titre:"",action:function(){e.log_and_open_link("CCN","http://archeologies.laclasse.com/")}},{color:"orange",icon:"/app/node_modules/laclasse-common-client/images/thematiques/icon_bd.svg",nom:"BD",titre:"",action:function(){e.log_and_open_link("CCN","http://bd.laclasse.com/?url=spip.php%3Fpage%3Dsommaire&cicas=oui")}},{color:"violet",icon:"/app/node_modules/laclasse-common-client/images/thematiques/icon_cine.svg",nom:"Cin\xe9",titre:"",action:function(){e.log_and_open_link("CCN","http://cine.laclasse.com/?url=spip.php%3Fpage%3Dsommaire&cicas=oui")}},{color:"vert",icon:"/app/node_modules/laclasse-common-client/images/thematiques/icon_cluemo.svg",nom:"Clu\xe9mo",titre:"",action:function(){e.log_and_open_link("CCN","http://cluemo.laclasse.com/?url=spip.php%3Fpage%3Dsommaire&cicas=oui")}},{color:"rouge",icon:"/app/node_modules/laclasse-common-client/images/thematiques/icon_etudiantsvoyageurs.svg",nom:"Etudiants voyageurs",titre:"",action:function(){e.log_and_open_link("CCN","http://etudiantsvoyageurs.laclasse.com/?url=spip.php%3Fpage%3Dsommaire&cicas=oui")}},{color:"vert",icon:"/app/node_modules/laclasse-common-client/images/thematiques/icon_finisterrae.svg",nom:"Finisterrae",titre:"",action:function(){e.log_and_open_link("CCN","http://finisterrae.laclasse.com/?url=spip.php%3Fpage%3Dsommaire&cicas=oui")}},{color:"gris4",icon:"/app/node_modules/laclasse-common-client/images/thematiques/icon_dechetmatiere.svg",nom:"Le d\xe9chet mati\xe8re",titre:"",action:function(){e.log_and_open_link("CCN","http://ledechetmatiere.laclasse.com/?url=spip.php%3Fpage%3Dsommaire&cicas=oui")}},{color:"violet",icon:"/app/node_modules/laclasse-common-client/images/thematiques/icon_maisondeladanse.svg",nom:"Maison de la danse",titre:"",action:function(){e.log_and_open_link("CCN","http://maisondeladanse.laclasse.com/?url=spip.php%3Fpage%3Dsommaire&cicas=oui")}},{color:"bleu",icon:"/app/node_modules/laclasse-common-client/images/thematiques/icon_musique.svg",nom:"Musique",titre:"",action:function(){e.log_and_open_link("CCN","http://musique.laclasse.com/")}},{color:"jaune",icon:"/app/node_modules/laclasse-common-client/images/thematiques/icon_science.svg",nom:"Science",titre:"",action:function(){e.log_and_open_link("CCN","http://science.laclasse.com/?url=spip.php%3Fpage%3Dsommaire&cicas=oui")}},{color:"orange",icon:"/app/node_modules/laclasse-common-client/images/thematiques/icon_picture.svg",nom:"Picture",titre:"",action:function(){e.log_and_open_link("CCN","http://picture.laclasse.com/?url=spip.php%3Fpage%3Dsommaire&cicas=oui")}}]}];return n.get(!1).then(function(n){["DIR","ENS","DOC"].includes(n.active_profile().type)&&t.push({nom:"Projets 2017-2018",description:"",icon:"/app/node_modules/laclasse-common-client/images/06_thematiques.svg",color:"bleu-plus",action:function(){e.log_and_open_link("inscription_CCN","https://www.laclasse.com/portail/inscription_CCN/index.html")}})}),t}}]),angular.module("portailApp").service("Annuaire",["$http","URL_ENT","CONFIG",function(e,n,t){var i=this;i.get_structure=_.memoize(function(t){return e.get(n+"/api/structures/"+t,{params:{expand:!1}})}),i.get_structures=_.memoize(function(t){return e.get(n+"/api/structures/",{params:{"id[]":t,expand:!1}})}),i.get_structure_tiles=_.memoize(function(t){return e.get(n+"/api/tiles/",{params:{structure_id:t}})}),i.query_applications=_.memoize(function(){return e.get(n+"/api/applications/").then(function(e){return _.chain(e.data).reject(function(e){var n=["ANNUAIRE","ANN_ENT","PORTAIL","SSO","STARTBOX"];return _(n).includes(e.id)}).map(function(e){return _(t.apps["default"][e.id])?(e.type="INTERNAL",e.application_id=e.id,delete e.id,_(e).extend(t.apps["default"][e.application_id])):null}).compact().value()})}),i.get_structure_resources=_.memoize(function(t){return e.get(n+"/api/resources/",{params:{"structures.structure_id":t}})}),i.get_profile_type=_.memoize(function(t){return e.get(n+"/api/profiles_types/"+t)}),i.get_resource=_.memoize(function(t){return e.get(n+"/api/resources/"+t)}),i.get_users=_.memoize(function(t){return e.get(n+"/api/users/",{params:{"id[]":t}})})}]),angular.module("portailApp").service("currentUser",["$http","$resource","$q","URL_ENT","User","Tiles","Annuaire",function(e,n,t,i,a,r,l){var o=this,s=undefined;o.get=function(n){return(_(s).isUndefined()||n)&&(s=e.get(i+"/api/users/current").then(function(e){return new a(e.data)})),s},o.activate_profile=function(n){return o.get(!1).then(function(t){return e({method:"PUT",url:i+"/api/users/"+t.id+"/profiles/"+n,data:{active:!0}})})},o.ressources=function(){return o.get(!1).then(function(e){return l.get_structure_resources(e.active_profile().structure_id).then(function(e){return e.data})})},o.tiles=function(){return o.get(!1).then(function(e){return _(e.profiles).isEmpty()?l.query_applications().then(function(e){var n=_.chain(e).select(function(e){return _(["MAIL","DOC"]).includes(e.application_id)}).map(function(e){return e.summer=!0,e}).value();return t.resolve(n)}):r.query({structure_id:e.active_profile().structure_id}).$promise})},o.groups=function(){return o.get(!1).then(function(n){var a=_.chain(n.profiles).pluck("structure_id").uniq().value(),r=l.get_structures(a),o=_(n.groups).pluck("group_id"),s=_(o).isEmpty()?t.resolve([]):e.get(i+"/api/groups/",{params:{"id[]":o}}).then(function(e){return e.data}),c=t.resolve([]);return _.chain(n.profiles).pluck("type").intersection(["DIR","ADM","CPE"]).value().length>0&&(c=e.get(i+"/api/groups/",{params:{"structure_id[]":a}}).then(function(e){return e.data})),t.all([s,c,r]).then(function(e){var n=e.pop().data;return _.chain(e).flatten().uniq("id").map(function(e){return e.structure=_(n).findWhere({id:e.structure_id}),e}).value()})})}}]),angular.module("portailApp").service("log",["$http","$state","URL_ENT","APP_PATH","currentUser",function(e,n,t,i,a){this.add=function(r,l,o){a.get(!1).then(function(a){e.post(t+"/api/logs",{application_id:r,user_id:a.id,structure_id:a.active_profile()?a.active_profile().structure_id:"none",profil_id:a.active_profile()?a.active_profile().type:"none",url:_(l).isNull()?i+n.current.url:l,parameters:_(o).isNull()?_(n.params).map(function(e,n){return n+"="+e}).join("&"):o})})}}]),angular.module("portailApp").service("Popups",["$uibModal",function(e){var n=this;n.add_tiles=function(n,t,i){e.open({controller:["$scope","$uibModalInstance","APP_PATH","Tiles","currentUser","Annuaire","current_tiles",function(e,n,t,i,a,r,l){e.prefix=t,e.available_tiles=[],e.tiles_selected=!1,e.add_empty_link_tile=function(){e.available_tiles.push(new i({creation:!0,present:!1,type:"EXTERNAL",name:"",description:"",url:"http://",color:"",selected:!0,taxonomy:"app"}))},e.keep_tile_selected=function(n,t){t.selected=!1,e.selected(t),n.stopImmediatePropagation()},e.selected=function(n){n.selected=!n.selected,e.tiles_selected=_(e.available_tiles).select({selected:!0}).length>0},e.ok=function(){n.close(_(e.available_tiles).select({selected:!0}))},e.cancel=function(){n.dismiss()},r.query_applications().then(function(n){e.available_tiles=e.available_tiles.concat(_.chain(n).uniq(function(e){return e.application_id}).each(function(e){e.taxonomy="app",e.available=function(){return!_.chain(l).reject(function(e){return e.to_delete}).pluck("application_id").contains(e.application_id).value()}}).value()),_(e.available_tiles).each(function(e){e.selected=!1})})}],resolve:{current_tiles:function(){return n}},template:'\n<div class="modal-header">\n    <h3 class="modal-title">Ajouter une tuile</h3>\n</div>\n<div class="modal-body available-apps">\n    <ul>\n        <li class="new-app"\n            ng:repeat="tile in available_tiles"\n            ng:if="tile.available() || tile.creation"\n            ng:class="{\'selected\': tile.selected, \'creation\': tile.creation, \'pronote\': tile.application_id == \'PRONOTE\'}"\n            ng:click="selected( tile )">\n\n            <a ng:if="!tile.creation"\n               title="{{ tile.description }}"\n               ng:style="{\'background-color\': tile.color }">\n                <img draggable="false" class="icone" ng:src="{{prefix}}/{{tile.icon}}"\n                     ng:if="tile.icon"/>\n                <span class="app-name" ng:cloak>{{ tile.name }}</span>\n                <label ng:if="tile.application_id == \'PRONOTE\'">lien <input type="text" ng:model="tile.url" ng:click="keep_tile_selected( $event, tile )"/></label>\n            </a>\n\n            <fieldset ng:if="tile.creation">\n                <legend>lien libre</legend>\n\n                <label>libell\xe9 <input type="text" ng:model="tile.name" ng:click="keep_tile_selected( $event, tile )" /></label>\n                <label>lien <input type="text" ng:model="tile.url" ng:click="keep_tile_selected( $event, tile )" /></label>\n            </fieldset>\n        </li>\n    </ul>\n    <div class="clearfix"></div>\n</div>\n<div class="modal-footer">\n    <button class="btn btn-primary pull-left" ng:click="add_empty_link_tile()">\n        <span class="glyphicon glyphicon-plus-sign"></span> Ajouter un lien libre\n    </button>\n\n    <button class="btn btn-default" ng:click="cancel()">\n        <span class="glyphicon glyphicon-remove-sign"></span> <span ng:if="tiles_selected">Annuler</span><span ng:if="!tiles_selected">Fermer</span>\n    </button>\n    <button class="btn btn-success"\n            ng:click="ok()"\n            ng:disabled="!tiles_selected">\n        <span class="glyphicon glyphicon-ok-sign"></span> Valider\n    </button>\n</div>\n',backdrop:"static"}).result.then(t,i)},n.manage_fluxes=function(n,t){e.open({template:'\n<div class="modal-header">\n    <h3 class="modal-title">G\xe9rer les flux RSS affich\xe9s sur le portail de l\'\xe9tablissement</h3>\n</div>\n<div class="modal-body config-fluxes">\n    <ul>\n        <li ng:repeat="flux in $ctrl.current_flux">\n            <label>titre <input type="text"\n                                ng:model="flux.name"\n                                ng:change="$ctrl.dirtify( flux )" /></label>\n            <label>url <input type="text"\n                              ng:model="flux.url"\n                              ng:change="$ctrl.dirtify( flux )" /></label>\n\n            <div class="controls">\n                <button class="btn-default delete"\n                        ng:click="$ctrl.delete( flux )"><span class="glyphicon glyphicon-trash"></span></button>\n                <button class="btn-primary save"\n                        ng:if="flux.dirty"\n                        ng:click="$ctrl.save( flux )"><span class="glyphicon glyphicon-ok-sign"></span></button>\n            </div>\n            <div class="clearfix"></div>\n        </li>\n    </ul>\n    <div class="clearfix"></div>\n\n    <button style="right: 4em;"\n            ng:click="$ctrl.add_default_flux()"><span class="glyphicon glyphicon-cloud-download"></span></button>\n    <button ng:click="$ctrl.add_flux()"><span class="glyphicon glyphicon-plus-sign"></span></button>\n</div>\n<div class="modal-footer">\n    <button class="btn btn-default" ng:click="$ctrl.close()">\n        <span class="glyphicon glyphicon-remove-sign"></span> Fermer\n    </button>\n</div>\n',controller:["$scope","$uibModalInstance","currentUser","Flux","CONFIG",function(e,n,t,i,a){var r=e;r.$ctrl=r,r.nb_articles=_.range(1,11),r.current_flux=[],r["delete"]=function(e){e.$delete(),r.current_flux=_(r.current_flux).difference([e])},r.save=function(e){return e.structure_id=r.user.active_profile().structure_id,_(e).has("id")?e.$update():e.$save()},r.dirtify=function(e){e.dirty=!0},r.add_flux=function(){r.current_flux.push(new i({name:"",url:"",icon:""}))},r.add_default_flux=function(){_(a.news_feed).each(function(e){r.dirtify(e),r.current_flux.push(new i(e))})},r.close=function(){n.close()},r.$onInit=function(){t.get(!1).then(function(e){r.user=e,i.get({structure_id:r.user.active_profile().structure_id}).$promise.then(function(e){r.current_flux=_(e).map(function(e){return e.dirty=!1,e})})})},r.$onInit()}],backdrop:"static"}).result.then(n,t)}}]),angular.module("portailApp").service("Utils",["$state","$window","CASES","log",function(e,n,t,i){this.pad_tiles_tree=function(e){return e.concat(_(t.slice(e.length,t.length)).map(function(n,t){return{index:t+e.length,color:n.color+"-moins"}}))},this.fill_empty_tiles=function(e){var n=e.map(function(e){return e.index});return _.chain(n).max().range().difference(n).each(function(n){e.push({index:n,color:t[n%t.length].color+"-moins"})}),e},this.log_and_open_link=function(e,t){i.add(e,t,null),n.open(t)},this.go_home=function(){e.go("portail",{},{reload:!0,inherit:!0,notify:!0})}}]),angular.module("statsApp",["ui.bootstrap","nvd3","angularMoment"]).run(["amMoment",function(e){e.changeLocale("fr")}]).config(["$httpProvider",function(e){e.defaults.withCredentials=!0}]).controller("StatsCtrl",["$scope","$http","$locale","moment","URL_ENT",function(e,n,t,i,a){var r=e;r.$ctrl=r,r.allowed=!1,n.get(a+"/api/users/current").then(function(e){r.allowed=_.chain(e.data.profiles).pluck("type").intersection(["DIR","ADM"]).value().length>0,r.allowed&&(r.types_labels={global:"Statistiques globales",structure_id:"\xc9tablissements",application_id:"Tuiles",profil_id:"Profils utilisateurs",user_id:"Utilisateurs",week_day:"Jour de la semaine"},r.period_types={list:[{label:"jour",value:"day"},{label:"semaine",value:"week"},{label:"mois",value:"month"},{label:"ann\xe9e",value:"year"}],selected:"week"},r.multibarchart_options={chart:{type:"multiBarChart",height:256,width:1050,margin:{left:50,top:20,bottom:100,right:20},showControls:!1,showValues:!0,showLegend:!0,stacked:!1,duration:500,labelThreshold:.01,labelSunbeamLayout:!0,rotateLabels:-25,reduceXTicks:!1}},r.multibarhorizontalchart_options=angular.copy(r.multibarchart_options),r.multibarhorizontalchart_options.chart.type="multiBarHorizontalChart",r.multibarhorizontalchart_options.chart.height=512,r.multibarhorizontalchart_options.chart.margin={left:250,top:20,bottom:20,right:50},r.chart_options=function(e,n){switch(e){case"structure_id":case"profil_id":return r.multibarhorizontalchart_options.chart.height=24*n.length*n[0].values.length+40,r.multibarhorizontalchart_options.chart.margin.left=8*_.chain(n[0].values).pluck("x").map(function(e){return e.length}).max().value(),r.multibarhorizontalchart_options;default:return r.multibarchart_options}},r.retrieve_data=function(){i();r.fin=r.debut.clone().endOf(r.period_types.selected),r.labels={},r.labels.week_day=angular.copy(t.DATETIME_FORMATS.DAY),r.labels.week_day.push(r.labels.week_day.shift()),n.get(a+"/api/profiles_types").then(function(e){r.labels.profil_id=_.chain(e.data).map(function(e){return[e.id,e.name]}).object().value()}),n.get(a+"/api/applications").then(function(e){r.labels.application_id=_.chain(e.data).map(function(e){return[e.id,e.name]}).object().value()}),n.get(a+"/api/structures_types").then(function(e){r.structures_types=e.data}),n.get(a+"/api/structures",{params:{expand:!1}}).then(function(e){r.labels.structure_id=_.chain(e.data).map(function(e){return[e.id,e.name+" ("+e.id+")"]}).object().value(),n.get(a+"/api/logs",{params:{"timestamp>":r.debut.clone().toDate(),"timestamp<":r.fin.clone().toDate(),"structure_id[]":_.chain(r.labels.structure_id).keys().reject(function(e){return _(["0699990Z","069BACAS","069DANEZ"]).contains(e)}).value()}}).then(function(e){var n=["structure_id","application_id","profil_id","week_day"],t=function(e,n){return[{key:e,values:_.chain(n).keys().map(function(t){return{key:e,value:t,x:r.labels[e][t],y:n[t]}}).sortBy(function(n){switch(e){case"structure_id":case"profil_id":return-1*n.y;case"week_day":return!0;default:return n.x}}).value()}]},i=function(e,n){return _.chain(n).map(function(n){return[n,t(n,_(e).countBy(n))]}).object().value()};r.logs=e.data,r.filters={},r.stats={},r.stats.global=i(r.logs,n),n.forEach(function(e){"week_day"!==e&&(r.stats[e]=_.chain(r.stats.global[e][0].values).pluck("value").map(function(t){return[t,i(_(r.logs).select(function(n){return n[e]===t}),_(n).difference([e]))]}).object().value())}),r.stats.global.structure_id.push({key:"utilisateurs uniques",values:_.chain(r.logs).groupBy(function(e){return e.structure_id}).map(function(e,n){return{key:"utilisateurs uniques",x:r.labels.structure_id[n],y:_.chain(e).pluck("user_id").uniq().value().length}}).value()}),r.stats.global.structure_id.push({key:"apps",values:_.chain(r.logs).groupBy(function(e){return e.structure_id}).map(function(e,n){return{key:"apps",x:r.labels.structure_id[n],y:_.chain(e).pluck("application_id").uniq().value().length}}).value()}),r.stats.global.profil_id.push({key:"utilisateurs uniques",values:_.chain(r.logs).groupBy(function(e){return e.profil_id}).map(function(e,n){return{key:"utilisateurs uniques",x:r.labels.profil_id[n],y:_.chain(e).pluck("user_id").uniq().value().length}}).value()}),_(r.stats.structure_id).each(function(e,n){e.profil_id.push({key:"utilisateurs uniques",values:_.chain(r.logs).where({structure_id:n}).groupBy(function(e){return e.profil_id}).map(function(e,n){return{key:"utilisateurs uniques",x:r.labels.profil_id[n],y:_.chain(e).pluck("user_id").uniq().value().length}}).value()})})})})},r.decr_period=function(){r.debut.subtract(1,r.period_types.selected+"s"),r.retrieve_data(r.debut)},r.incr_period=function(){r.debut.add(1,r.period_types.selected+"s"),r.retrieve_data(r.debut)},r.reset_period=function(){r.debut=i().startOf(r.period_types.selected),r.retrieve_data(r.debut)},r.reset_period())})}]),angular.module("portailApp").run(["$templateCache",function(e){e.put("views/aside_CCNUM.html",'<div class="laius">    <h2>{{parent.description}}</h2>    <br>    <p>        Des coll\xe9giens qui jouent sur le web et sur sc\xe8ne avec des auteurs de th\xe9\xe2tre et des \xe9crivains, qui d\xe9couvrent que design et d\xe9veloppement durable peuvent s\'allier contre le gaspillage alimentaire, qui cartographient leur territoire gr\xe2ce \xe0 la Big Data en compagnie d\'un philosophe, ou encore qui r\xe9alisent une enqu\xeate-expo sur la grande guerre avec les archives du Rh\xf4ne, tout cela ce sont les Classes Culturelles Num\xe9riques de laclasse.com. 50 classes, du cm2 \xe0 la 3\xe8me engag\xe9es dans 5 projets collaboratifs et innovants sur l\'ENT, \xe0 suivre en ligne toute l\'ann\xe9e, et lors des rencontres finales.    </p>    <p>        En partenariat avec <a href="http://www.ia69.ac-lyon.fr/" target="_blank">l\'Inspection Acad\xe9mique</a> et la DANE de <a href="http://www.ac-lyon.fr/" target="_blank">l\'Acad\xe9mie de Lyon</a>.    </p>    <p>        <a href="https://www.laclasse.com/portail/inscription_CCN_2016/index.html">Description d\xe9taill\xe9e des Classes Culturelles Num\xe9riques de cette ann\xe9e</a>    </p>    <p>        <a href="https://www.laclasse.com/portail/inscription_CCN/index.html">D\xe9couvrez les Classes Culturelles Num\xe9riques de l\'ann\xe9e prochaine.</a>    </p>    <p>        Inscriptions en mai : <a href="mailto:info@laclasse.com">info@laclasse.com</a>    </p></div>')}]),angular.module("portailApp").run(["$templateCache",function(e){e.put("views/aside_CCNUM_archives.html",'<div class="laius">    <h2>{{parent.description}}</h2>    <br>    <p>        Au fil des ann\xe9es, des projets p\xe9dagogiques, des r\xe9sidences d\'artistes, de scientifiques, et d\'\xe9crivains se sont d\xe9roul\xe9s dans tout le d\xe9partement du rh\xf4ne, et parfois au del\xe0, amenant plusieurs classes de diff\xe9rents \xe9tablissements \xe0 travailler ensemble autour de l\'outil num\xe9rique.    </p>    <p>        Retrouver et revisitez les travaux des classes sur ces projets, ici.    </p>    <p>        <a href="https://www.laclasse.com/portail/inscription_CCN_2016/index.html">Description d\xe9taill\xe9e des Classes Culturelles Num\xe9riques de cette ann\xe9e</a>    </p>    <p>        <a href="https://www.laclasse.com/portail/inscription_CCN/index.html">D\xe9couvrez les Classes Culturelles Num\xe9riques de l\'ann\xe9e prochaine.</a>    </p></div>')}]),angular.module("portailApp").run(["$templateCache",function(e){e.put("views/aside_RN.html","<div class=\"laius\"    <h2>{{parent.description}}</h2>    <br>    <p>        Retrouvez ici les ressources num\xe9riques que votre \xe9tablissement a s\xe9lectionn\xe9 pour vous. Ces ressources peuvent \xeatre des manuels scolaires en ligne, des dictionnaires, des sites proposant des ressources pour s'entra\xeener, etc...    </p>    <p>        Si rien n'est affich\xe9 dans cette page, c'est que votre \xe9tablissement n'a pas encore activ\xe9 les ressources num\xe9riques. Vous pouvez contacter un de vos administrateur de l'ENT pour lui demander l'activation de celles-ci.    </p></div>")}]),angular.module("portailApp").run(["$templateCache",function(e){e.put("views/aside_TROMBI_people.html",'<div class="laius">    <h2>{{parent.description}}</h2>    <br>    <div class="blanc form-horizontal"         style="height: auto;">        <div class="col-md-12 form-group">            <label for="text"                   class="col-md-3 control-label">Filtre :</label>            <div class="col-md-8">                <input id="text"                       class="form-control gris1"                       ng:model="filter_criteria.text" />            </div>        </div>    </div></div>')}]),angular.module("portailApp").run(["$templateCache",function(e){e.put("views/aside_TROMBI_regroupements.html",'<div class="laius">    <h2>{{parent.description}}</h2>    <br>    <div class="blanc form-horizontal"         style="height: auto;">        <div class="col-md-12 form-group">            <label for="text"                   class="col-md-3 control-label">Filtre :</label>            <div class="col-md-8">                <input id="text"                       class="form-control gris1"                       ng:model="filter_criteria.text" />            </div>        </div>        <div class="col-md-12 form-group">            <checkbox id="showclasses"                      class="form-control checkbox"                      ng:model="filter_criteria.show_classes"></checkbox>            <label for="showclasses"                   class="col-md-3 control-label">Classes </label>        </div>        <div class="col-md-12 form-group">            <checkbox id="showgroupesdeleves"                      class="form-control checkbox"                      ng:model="filter_criteria.show_groupes_eleves"></checkbox>            <label for="showgroupesdeleves"                   class="col-md-3 control-label">Groupes d\'\xe9l\xe8ves </label>        </div>        <div class="col-md-12 form-group">            <checkbox id="showgroupeslibres"                      class="form-control checkbox"                      ng:model="filter_criteria.show_groupes_libres"></checkbox>            <label for="showgroupeslibres"                   class="col-md-3 control-label">Groupes libres </label>        </div>    </div></div>')}]),angular.module("portailApp").run(["$templateCache",function(e){e.put("views/aside_news.html",'<news class="news gris4"      edition="$ctrl.modification"></news>')}]),angular.module("portailApp").run(["$templateCache",function(e){e.put("views/tile_app.html",'<div class="flippable"     ng:class="{ \'show-back\': tile.configure }">    <div class="as-sortable-item-handle"         data-as-sortable-item-handle         ng:style="{\'background-color\': tile.color + \'77\' }">    <div class="front"         ng:class="{\'deleted\': tile.to_delete}"         ng:style="{\'background-color\': tile.color}">        <button class="btn btn-lg toggle-configure open-configure"                ng:if="$ctrl.modification"                ng:click="tile.toggle_configure()">            <span class="icone parametrer"></span>        </button>        <ng-color-picker class="couleurs"                         ng:click="tile.is_dirty( \'color\' )"                         ng:if="$ctrl.modification"                         selected="tile.color"                         colors="$ctrl.COULEURS"></ng-color-picker>        <div class="tile-icone"           ng:click="tile.action()"           title="{{tile.description}}"           style="cursor: pointer">            <div class="icone"                 fittext                 ng:if="!tile.icon">                {{tile.name[0]}}            </div>            <img draggable="false"                 class="icone"                 ng:src="{{$ctrl.prefix}}/{{ tile.icon }}"                 ng:if="tile.icon">            <span class="app-name">                {{tile.name}}                <i class="glyphicon glyphicon-new-window"                   ng:if="tile.type === \'EXTERNAL\'"></i>            </span>        </div>    </div>    <div class="configure back blanc"         ng:if="$ctrl.modification">        <button class="btn btn-lg toggle-configure close-configure"                ng:click="tile.toggle_configure()">            <span class="icone visualiser"></span>        </button>        <button class="btn btn-xs btn-link remove glyphicon glyphicon-trash"                ng:click="tile.remove()"></button>        <label>            nom : <input type="text" class="form-control"                         ng:model="tile.name"                         ng:change="tile.is_dirty( \'name\' )" />        </label>        <label>            description : <input type="text" class="form-control"                                 ng:model="tile.description"                                 ng:change="tile.is_dirty( \'description\' )" />        </label>        <label ng:if="tile.type === \'EXTERNAL\' || tile.application_id == \'PRONOTE\'">            url : <input type="text" class="form-control"                         ng:model="tile.url"                         ng:change="tile.is_dirty( \'url\' )" />        </label>    </div>    </div></div>')}]),angular.module("portailApp").run(["$templateCache",function(e){e.put("views/tile_ccn.html",'<a href   ng:click="tile.action()"   title="{{tile.description}}"   target="_blank">    <img draggable="false"         class="icone"         ng:src="{{$ctrl.prefix}}{{ tile.icon }}"         ng:if="tile.icon">    <span class="app-name">        {{tile.nom}}        <i class="glyphicon glyphicon-new-window" ng:if="tile.type === \'EXTERNAL\'"></i>    </span></a>')}]),angular.module("portailApp").run(["$templateCache",function(e){e.put("views/tile_eleve.html",'<div ng:style="{ \'background\': \'no-repeat center/100% url({{tile.avatar}})\' }">    <a href       ng:click="tile.action()"       title="{{tile.firstname + \' \' + tile.lastname}}"       target="_blank">        <h1 style="background-color: rgba(0, 0, 0, 0.2);">{{tile.lastname}}</h1>        <h3 style="background-color: rgba(0, 0, 0, 0.2);">{{tile.firstname}}</h3>    </a></div>')}]),angular.module("portailApp").run(["$templateCache",function(e){e.put("views/tile_regroupement.html",'<a href   ng:click="tile.action()"   title="{{tile.description}}"   target="_blank">    <h1>{{tile.name}}</h1>    <em>{{tile.structure.name}}</em></a>')}]),angular.module("portailApp").run(["$templateCache",function(e){e.put("views/tile_rn.html",'<a href   ng:click="tile.action()"   title="{{tile.name}}"   target="_blank">    <img draggable="false"         class="icone"         ng:src="{{ tile.icon }}"         ng:if="tile.icon">    <span class="app-name">        {{tile.name}}        <i class="glyphicon glyphicon-new-window" ng:if="tile.type === \'EXTERNAL\'"></i>    </span></a>')}]);